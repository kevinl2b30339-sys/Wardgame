<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æŸ¥æˆ¿é¢¨é›² Ward Rounds - åœ‹è€ƒäº‹ä»¶çªç™¼ç‰ˆ</title>
    <style>
        /* å…¨è¢å¹•é–å®šèˆ‡ Flexbox æ’ç‰ˆ */
        body { background-color: #f4f7f6; font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; text-align: center; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* åŸºç¤å¡ç‰Œæ¨£å¼ */
        .card { border: 2px solid #2c3e50; padding: 4px; margin: 2px; display: inline-block; background: white; border-radius: 8px; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); width: 80px; vertical-align: top; position: relative; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; user-select: none; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 105px;}
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .card.selected { border-color: #e74c3c; transform: translateY(-10px); box-shadow: 0 10px 20px rgba(231, 76, 60, 0.4); }
        
        .card-img-container { width: 100%; height: 45px; display: flex; justify-content: center; align-items: center; margin-bottom: 2px; overflow: hidden; border-radius: 4px; position: relative; background-color: #f8f9fa;}
        .card-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; position: relative; z-index: 2; background-color: white;}
        .fallback-icon { position: absolute; z-index: 1; font-size: 28px; opacity: 0.8;}
        
        .card-title { font-size: 12px; font-weight: bold; margin-bottom: 2px; text-align: center; line-height: 1.1;}
        .card-type-badge { display: inline-block; background: #eee; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-top: auto;}
        .action-desc { font-size: 9px; color: #c0392b; margin-top: 3px; font-weight: bold; text-align: center; line-height: 1.1;}

        /* ç©å®¶æ‰‹ç‰Œæ”¾å¤§å°ˆå±¬æ¨£å¼ */
        #hand-cards .card, #action-hand-cards .card { width: 105px; min-height: 150px; padding: 6px;}
        #hand-cards .card-img-container, #action-hand-cards .card-img-container { height: 75px; margin-bottom: 5px;}
        #hand-cards .card-title, #action-hand-cards .card-title { font-size: 15px; }
        #action-hand-cards .action-desc { font-size: 11px; }

        /* å¡ç‰Œé‚Šæ¡†é¡è‰² */
        .type-CC { border-top: 6px solid #e74c3c; } .type-Sx { border-top: 6px solid #f1c40f; } .type-Dx { border-top: 6px solid #9b59b6; } .type-Tx { border-top: 6px solid #2ecc71; }
        .type-Action { border: 2px solid #c0392b; background-color: #fff5f5; }
        .type-Wildcard { border-top: 6px solid #e67e22; background-color: #fdf2e9; border-color: #d35400;}

        /* å‹•ç•«ç³»çµ± */
        @keyframes popIn { 0% { transform: translateY(-40px) scale(0.8); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
        .animate-enter { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes flyOut { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.5) translateY(-80px) rotate(15deg); opacity: 0; } }
        .animate-exit { animation: flyOut 0.3s forwards; pointer-events: none; }
        @keyframes floatUp { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.1) translateY(-100px); opacity: 0; filter: blur(2px); } }
        .animate-admit { animation: floatUp 0.4s forwards; pointer-events: none; }

        /* ç‰¹æ•ˆ */
        @keyframes pulse-border {
            0% { border-color: rgba(230, 126, 34, 0.5); box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
            50% { border-color: rgba(230, 126, 34, 1); box-shadow: 0 0 15px rgba(230, 126, 34, 1); }
            100% { border-color: rgba(230, 126, 34, 0.5); box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
        }

        /* è¢å¹•è­¦å ±é–ƒçˆç‰¹æ•ˆ */
        @keyframes alarmFlash { 0% { background-color: transparent; } 50% { background-color: var(--flash-color); } 100% { background-color: transparent; } }
        #flash-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 8000; }
        .flashing { display: block !important; animation: alarmFlash 1s infinite; }

        /* ç‰ˆé¢å€å¡ŠåŠƒåˆ† */
        h2 { font-size: 15px; margin: 2px 0; color: #2c3e50;}
        .hand-container { border: 1px dashed #ccc; padding: 5px; margin: 2px auto; background-color: #fff; display: flex; flex-wrap: wrap; justify-content: center; align-items: center;}
        
        #opponents-container { display: flex; justify-content: space-around; width: 100%; padding: 5px 0; background: #e8eaed; flex-shrink: 0;}
        .bot-area { flex: 1; background-color: #fff; border: 2px solid #bdc3c7; padding: 4px; margin: 0 4px; border-radius: 8px; position: relative; }
        .bot-area.active-turn { border-color: #e67e22; box-shadow: 0 0 10px rgba(230, 126, 34, 0.4); background-color: #fdf2e9; }
        .bot-card-back { background-color: #7f8c8d; color: white; border: 1px solid #2c3e50; width: 18px; height: 26px; display: inline-block; margin: 1px; border-radius: 3px; font-size: 8px; line-height: 26px;}
        .bot-case-card { display: inline-block; background: #fff; border: 1px solid #7f8c8d; padding: 2px 4px; border-radius: 4px; font-size: 11px; margin: 1px; }

        /* ä¸­å¤®è³‡è¨Šå€ */
        #center-zone { display: flex; justify-content: center; align-items: center; gap: 30px; flex-shrink: 0; padding: 5px 0; background: #ecf0f1; border-bottom: 2px solid #bdc3c7;}
        #discard-pile { background-color: #fff; border: 2px dashed #95a5a6; padding: 5px; border-radius: 8px; cursor: pointer; min-height: 70px; width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        
        #event-timer-box { background: #34495e; color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid #f1c40f;}

        /* ç©å®¶æ“ä½œå€ */
        #player-zone { flex-grow: 1; display: flex; flex-direction: column; padding: 5px; background: #f4f7f6; overflow: hidden;}
        
        #table-cards-container { width: 98%; margin: 0 auto 5px auto; }
        #table-cards { min-height: 40px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; background: #fafafa; padding: 5px;}

        /* æ§åˆ¶åˆ— */
        .control-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 5px 0; flex-wrap: wrap; flex-shrink: 0;}
        .btn-action { font-size: 14px; padding: 6px 15px; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s;}
        .btn-action:hover { filter: brightness(1.1); transform: scale(1.05);}
        .btn-action.disabled { background-color: #95a5a6 !important; cursor: not-allowed; transform: none;}
        #draw-btn { background-color: #3498db; font-size: 15px; }
        #admit-btn { background-color: #2ecc71; } 
        #discard-btn { background-color: #e74c3c; } 
        #end-btn { background-color: #8e44ad; } 
        #guide-btn { background-color: #f39c12; }

        /* é›™å€ä¸¦åˆ—ç‰ˆé¢é…ç½® */
        #dual-hand-zone { display: flex; justify-content: space-between; width: 98%; margin: 0 auto; flex-grow: 1; gap: 10px; overflow: hidden;}
        .hand-column { display: flex; flex-direction: column; height: 100%; border-radius: 8px; overflow: hidden;}
        .hand-column-title { background: #34495e; color: white; padding: 5px; font-size: 14px; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px; margin: 0; display: flex; justify-content: space-between; align-items: center;}
        
        #med-hand-col { flex: 7; background: #eafaf1; border: 2px solid #2ecc71;}
        #hand-cards { width: 100%; height: 100%; margin: 0; padding: 10px; background: transparent; border: none; align-content: flex-start; overflow-y: auto;}

        #act-hand-col { flex: 3; background: #fdedec; border: 2px solid #e74c3c;}
        #action-hand-cards { width: 100%; height: 100%; margin: 0; padding: 10px; background: transparent; border: none; align-content: flex-start; overflow-y: auto;}

        /* å½ˆçª—è¦†è“‹å±¤ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 40px auto; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-size: 14px; position: relative;}
        
        #start-screen, #game-over-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; color: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #game-wrapper { display: none; height: 100%; width: 100%; flex-direction: column;}
        .card.dragging { opacity: 0.5; }
        .player-turn-highlight { box-shadow: 0 0 15px #e67e22 !important; border: 2px solid #fff !important; }

        #toast-container { position: fixed; top: 10px; right: 10px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.85); color: white; padding: 10px 15px; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: slideInRight 0.3s forwards, fadeOutRight 0.5s 3.5s forwards; font-size: 14px; border: 1px solid #34495e;}
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOutRight { to { transform: translateX(100%); opacity: 0; } }

        #cinematic-overlay, #start-turn-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .cinematic-text { color: white; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 8px black; animation: popIn 0.5s forwards; text-align: center; margin-top: 15px;}
        .cinematic-card-display { transform: scale(4.5); margin-bottom: 180px; box-shadow: 0 0 80px #e74c3c; border-color: #e74c3c; pointer-events: none; animation: popIn 0.4s forwards; background: #fff; border-width: 3px; min-height: 120px;}
        
        /* å®£å‘Šå›åˆçš„å·¨å‹æ–‡å­— */
        .start-turn-text { font-size: 60px; font-weight: bold; color: #f1c40f; text-shadow: 4px 4px 15px black; animation: popIn 0.5s forwards; }

        .revealed-box { cursor: pointer; padding: 2px; border: 2px dashed #e67e22; border-radius: 5px; background: rgba(230, 126, 34, 0.1); transition: 0.2s; animation: pulse-border 1.5s infinite; }
        .revealed-box:hover { background: rgba(230, 126, 34, 0.3); transform: scale(1.05); }

        .exchange-selection-area .card { transform: scale(0.85); margin: -5px; border-width: 3px; }

        /* è‡¨åºŠæŒ‡å¼•è¡¨æ ¼æ¨£å¼ */
        .guide-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .guide-table th, .guide-table td { border: 1px solid #bdc3c7; padding: 8px; text-align: center; font-size: 13px; color: #2c3e50;}
        .guide-table th { background-color: #ecf0f1; font-weight: bold; }
        .guide-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .guide-table tbody tr:hover { background-color: #eafaf1; }

        /* äº‹ä»¶è€ƒé¡Œ Modal å°ˆå±¬æ¨£å¼ */
        #quiz-modal { z-index: 9999; }
        #quiz-modal .modal-content { max-width: 700px; border: 4px solid #e74c3c; box-shadow: 0 0 30px rgba(231, 76, 60, 0.6); }
        .quiz-option { display: block; width: 100%; text-align: left; padding: 12px; margin: 8px 0; font-size: 15px; border: 2px solid #bdc3c7; border-radius: 8px; background: #fff; cursor: pointer; transition: 0.2s; color: #2c3e50; font-weight: bold;}
        .quiz-option:hover { background: #fdf2e9; border-color: #e67e22; transform: scale(1.02); }
        
        /* å€’æ•¸è¨ˆæ™‚é€²åº¦æ¢ */
        #quiz-timer-bar-container { width: 100%; height: 10px; background-color: #eee; border-radius: 5px; margin-bottom: 15px; overflow: hidden; }
        #quiz-timer-bar { height: 100%; background-color: #e74c3c; width: 100%; transition: width 1s linear; }

        /* åœ‹è€ƒè¶¨å‹¢åˆ†ææŒ‰éˆ•æ¨£å¼ */
        .study-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            background-color: #e67e22; /* é¡¯çœ¼çš„æ©˜è‰² */
            border: none;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .study-btn:hover {
            background-color: #d35400;
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <div id="flash-overlay"></div>
    <div id="toast-container"></div>
    <div id="cinematic-overlay"><div id="cinematic-content" style="display:flex; flex-direction:column; align-items:center;"></div></div>
    
    <div id="start-turn-overlay">
        <div id="start-turn-msg" class="start-turn-text"></div>
    </div>

    <div id="start-screen">
        <h1 style="font-size: 48px; margin-bottom: 10px;">ğŸ¥ æŸ¥æˆ¿é¢¨é›²</h1>
        <h2 style="color: #f1c40f; margin-top: 0;">åœ‹è€ƒäº‹ä»¶çªç™¼ç‰ˆ </h2>
        <p style="margin-bottom: 30px;">å…«å¤§å…§ç§‘çªç™¼äº‹ä»¶ Ã— æ®˜é…·åœ‹è€ƒè€ƒé©—ï¼</p>
        <div>
            <button class="btn-action" style="font-size: 24px; padding: 15px 40px; background-color: #2ecc71; margin-right: 10px;" onclick="startGame()">â–¶ï¸ é–‹å§‹éŠæˆ²</button>
            <button class="btn-action" style="font-size: 24px; padding: 15px 40px; background-color: #3498db;" onclick="showTutorialModal()">ğŸ“– éŠæˆ²æ•™å­¸</button>
        </div>
    </div>

    <div id="game-over-screen" style="display: none;">
        <h1 id="victory-title" style="font-size: 48px; margin-bottom: 10px;"></h1>
        <p id="victory-desc" style="font-size: 20px; margin-bottom: 30px;"></p>
        <button class="btn-action" style="font-size: 20px; padding: 10px 30px; background-color: #3498db;" onclick="location.reload()">ğŸ”„ å†ç©ä¸€å±€</button>
        <a id="study-link" href="https://drive.google.com/file/d/165W8Jp0oNkYYtHTn1_k49HqZ4cOckktm/view?usp=drive_link" target="_blank" class="study-btn" style="display: none;">
            ğŸ“š ä¸‹è¼‰ï¼š2014~2024é†«å¸«äºŒéšåœ‹è€ƒè¶¨å‹¢åˆ†æ-å…§ç§‘
        </a>
    </div>

    <div id="discard-modal" class="modal" onclick="closeModal('discard-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="text-align:center;">ğŸ—‘ï¸ æ£„ç‰Œå †æ­·å²ç´€éŒ„</h3>
            <div id="discard-list" style="margin-bottom: 20px;"></div>
            <div style="text-align:center;"><button class="btn-action" style="background:#34495e;" onclick="closeModal('discard-modal')">é—œé–‰</button></div>
        </div>
    </div>
    
    <div id="tutorial-modal" class="modal" onclick="closeModal('tutorial-modal')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 650px;">
            <h2 style="color: #2c3e50; text-align: center; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">ğŸ“– ã€ŠæŸ¥æˆ¿é¢¨é›²ã€‹éŠæˆ²æ•™å­¸</h2>
            <div style="line-height: 1.6; color: #34495e; text-align: left; padding: 0 10px;">
                <h3 style="color: #e67e22;">ğŸ¯ éŠæˆ²ç›®æ¨™</h3>
                <p>ç‡å…ˆæˆåŠŸæ”¶æ²» <strong>2 åºŠ</strong>ç—…äººçš„ç©å®¶ï¼Œå³å¯å®£å‘Šå‹åˆ©ï¼Œææ—©æ´—æ‰‹ä¸‹ç­ï¼</p>
                <h3 style="color: #e67e22;">ğŸ•¹ï¸ å›åˆæµç¨‹</h3>
                <ol>
                    <li><strong>æŸ¥æˆ¿ (å¿…åŸ·è¡Œ)</strong>ï¼šå›åˆé–‹å§‹æ™‚ï¼Œé»æ“Šã€ŒğŸ“¦ æŠ½é†«å­¸ç‰Œã€æŠ½å–ä¸€å¼µç‰Œã€‚</li>
                    <li><strong>è¡Œå‹• (é¸åŸ·è¡Œ)</strong>ï¼šæ¯å›åˆæœ€å¤šå¯ä¸»å‹•æ‰“å‡º <strong>1 å¼µ</strong>åŠŸèƒ½ç‰Œã€‚è‹¥æ‰‹ç‰Œæ»¿è¶³ã€è‡¨åºŠæŒ‡å¼•ã€‘æ¢ä»¶ï¼Œå¯é»æ“Šã€ŒğŸ©º å®£å‘Šæ”¶æ²»ã€ã€‚(æ”¶æ²»å¾Œå¯ç¹¼çºŒè¡Œå‹•ç›´åˆ°çµæŸå›åˆ)</li>
                    <li><strong>çµæŸå›åˆ</strong>ï¼šè‹¥æ‰‹ç‰Œè¶…éä¸Šé™ (é è¨­ 7 å¼µ)ï¼Œä¸Ÿæ£„å¤šé¤˜æ‰‹ç‰Œå¾Œé»æ“ŠçµæŸã€‚</li>
                </ol>
                <h3 style="color: #8e44ad;">ğŸš¨ çªç™¼äº‹ä»¶ (Event)</h3>
                <p>ç¬¬ 2 å›åˆå°‡çˆ†ç™¼ç¬¬ä¸€æ¬¡å±æ©Ÿï¼Œä¹‹å¾Œæ¯ 3 æˆ– 4 å›åˆéš¨æ©Ÿçˆ†ç™¼å…¨é™¢ç§‘åˆ¥å±æ©Ÿï¼ä½ èˆ‡ AI åŒäº‹éœ€å›ç­”å½ˆå‡ºçš„åœ‹è€ƒé¡Œï¼ŒAI æœ‰ 60% æ©Ÿç‡ç­”å°ã€‚ç­”å°å¯ç²å¾—ç‰¹æ¬Šï¼Œç­”éŒ¯å‰‡é¢è‡¨æ‡²ç½°ï¼<strong style="color:red;">è«‹æ³¨æ„ï¼šä½œç­”æ™‚é–“åªæœ‰ 30 ç§’ï¼</strong></p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-action" style="background:#34495e; font-size:16px; padding:10px 30px;" onclick="closeModal('tutorial-modal')">æˆ‘çŸ¥é“äº†ï¼Œæº–å‚™æŸ¥æˆ¿ï¼</button>
            </div>
        </div>
    </div>

    <div id="guide-modal" class="modal" onclick="closeModal('guide-modal')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 850px;">
            <h3 style="text-align:center; color: #2c3e50; margin-bottom: 5px;">ğŸ“– è‡¨åºŠæŒ‡å¼• (å¯æ”¶æ²»çš„ç¶“å…¸ç—…æ­·)</h3>
            <p style="color:#e67e22; font-weight:bold; text-align:center; margin-top: 0; font-size: 13px;">âš ï¸ é™åˆ¶ï¼šä¸€åºŠç—…æ‚£æœ€å¤šåªèƒ½ä½¿ç”¨ 1 å¼µã€æœƒè¨ºå–®ã€‘ï¼è‹¥ä½¿ç”¨ DNR å…æ²» 3 å¼µç‰Œæ–¹æ¡ˆå‰‡ä¸å¯ä½¿ç”¨æœƒè¨ºå–®ã€‚</p>
            <table class="guide-table">
                <thead>
                    <tr><th>ç§‘åˆ¥</th><th>ç¶“å…¸ç—…æ­· (Case)</th><th>â¬œ ä¸»è¨´ (CC)</th><th>ğŸ”¬ ç—‡ç‹€/æª¢é©— (Sx/Lab)</th><th>ğŸ“‹ è¨ºæ–· (Dx)</th><th>ğŸ’Š æ²»ç™‚ (Tx)</th></tr>
                </thead>
                <tbody>
                    <tr><td>ğŸ©¸ è…è‡Ÿ</td><td><strong>è…ç—…ç—‡å€™ç¾¤</strong></td><td>ä¸‹è‚¢æ°´è…«</td><td>è›‹ç™½å°¿</td><td>è…ç—…ç—‡å€™ç¾¤</td><td>é¡å›ºé†‡</td></tr>
                    <tr><td>ğŸ©¸ è…è‡Ÿ</td><td><strong>æ€¥æ€§è…æå‚·(AKI)</strong></td><td>å¯¡å°¿ æˆ– ä¸‹è‚¢æ°´è…«</td><td>EGFRé©Ÿé™</td><td>æ€¥æ€§è…æå‚·(AKI)</td><td>è¡€æ¶²é€æ</td></tr>
                    <tr><td>ğŸ«€ å¿ƒè‡Ÿ</td><td><strong>æ€¥æ€§å¿ƒè‚Œæ¢—å¡</strong></td><td>èƒ¸ç—›</td><td>STæ®µä¸Šå‡</td><td>æ€¥æ€§å¿ƒè‚Œæ¢—å¡(AMI)</td><td>å¿ƒå°ç®¡ä»‹å…¥ æˆ– ç¡é…¸ç”˜æ²¹</td></tr>
                    <tr><td>ğŸ«€ å¿ƒè‡Ÿ</td><td><strong>é¬±è¡€æ€§å¿ƒè¡°ç«­</strong></td><td>å–˜ æˆ– ä¸‹è‚¢æ°´è…«</td><td>é ¸éœè„ˆæ€’å¼µ</td><td>é¬±è¡€æ€§å¿ƒè¡°ç«­(CHF)</td><td>åˆ©å°¿åŠ‘ æˆ– ç¡é…¸ç”˜æ²¹</td></tr>
                    <tr><td>ğŸ« èƒ¸è…”</td><td><strong>æ°£é“é˜»å¡</strong></td><td>å–˜</td><td>è‚ºéƒ¨å–˜é³´è²</td><td>COPDæ€¥æ€§ç™¼ä½œ æˆ– æ°£å–˜æ€¥æ€§ç™¼ä½œ</td><td>æ°£ç®¡æ“´å¼µåŠ‘</td></tr>
                    <tr><td>ğŸ« èƒ¸è…”</td><td><strong>åš´é‡è‚ºç‚</strong></td><td>ç™¼ç‡’ æˆ– å–˜</td><td>è‚ºéƒ¨æµ¸æ½¤ æˆ– è‚ºéƒ¨æ¿•é‘¼éŸ³</td><td>è‚ºç‚</td><td>æŠ—ç”Ÿç´ </td></tr>
                    <tr><td>ğŸŸ¨ è…¸èƒƒ</td><td><strong>æ€¥æ€§è…¹ç—‡</strong></td><td>è…¹ç—› æˆ– ç™¼ç‡’</td><td>è…¹éƒ¨å£“ç—›</td><td>è†½å›Šç‚ æˆ– é—Œå°¾ç‚</td><td>ç…§æœƒä¸€èˆ¬å¤–ç§‘ æˆ– æŠ—ç”Ÿç´ </td></tr>
                    <tr><td>ğŸŸ¨ è…¸èƒƒ</td><td><strong>è‚ç¡¬åŒ–åˆä½µè…¹æ°´</strong></td><td>ä¸‹è‚¢æ°´è…«</td><td>è…¹æ°´</td><td>è‚ç¡¬åŒ–</td><td>æŠ½è…¹æ°´ æˆ– åˆ©å°¿åŠ‘</td></tr>
                </tbody>
            </table>
            <div style="text-align:center; margin-top: 15px;"><button class="btn-action" style="background:#34495e;" onclick="closeModal('guide-modal')">é—œé–‰æŒ‡å¼•</button></div>
        </div>
    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <h2 id="quiz-dept-title" style="color: #c0392b; margin-top: 0; text-align: center;">ğŸš¨ ç§‘åˆ¥äº‹ä»¶</h2>
            <div id="quiz-timer-bar-container"><div id="quiz-timer-bar"></div></div>
            
            <div id="quiz-scenario" style="background: #fdedec; padding: 10px; border-radius: 5px; font-size: 13px; margin-bottom: 10px; color: #c0392b;">æƒ…å¢ƒ...</div>
            <div id="quiz-global" style="background: #eafaf1; border-left: 5px solid #2ecc71; padding: 10px; font-size: 14px; margin-bottom: 15px; font-weight: bold;">å…¨å ´æ•ˆæœ...</div>
            <h3 style="color: #2c3e50; font-size: 16px;">â“ åœ‹è€ƒå¤§è€ƒé©—ï¼š</h3>
            <p id="quiz-question-text" style="font-size: 15px; font-weight: bold; color: #34495e;">é¡Œç›®å…§å®¹...</p>
            <div id="quiz-options-container" style="display: flex; flex-direction: column;"></div>
        </div>
    </div>

    <div id="target-modal" class="modal"><div class="modal-content" style="max-width: 400px; text-align: center;"><h3>ğŸ¯ é¸æ“‡ä½ è¦ç™¼å‹•çš„ç›®æ¨™</h3><div id="target-buttons" style="margin: 20px 0;"></div><button class="btn-action" style="background:#95a5a6;" onclick="cancelTargetSelection()">å–æ¶ˆ</button></div></div>
    
    <div id="reveal-modal" class="modal" onclick="closeModal('reveal-modal')"><div class="modal-content" style="text-align: center; max-width: 900px; background: #fdf2e9; border: 3px solid #e67e22;" onclick="event.stopPropagation()"><h3 style="color:#d35400; font-size: 26px; margin-top: 0;">ğŸ‘€ <span id="reveal-target-name"></span> çš„éš±è—æ‰‹ç‰Œ</h3><p style="font-size: 14px; color: #7f8c8d;">(å·²è¢«ã€å ± Caseã€‘æˆ–äº‹ä»¶å…¬é–‹ï¼)</p><div id="reveal-hand-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0; min-height: 180px;"></div><button class="btn-action" style="background:#c0392b; font-size: 18px; padding: 10px 40px;" onclick="closeModal('reveal-modal')">âŒ é—œé–‰</button></div></div>
    
    <div id="select-card-modal" class="modal"><div class="modal-content" style="max-width: 500px; text-align: center;"><h3 id="select-card-title" style="color: #2c3e50;">æ¨™é¡Œ</h3><p id="select-card-msg" style="color: #7f8c8d; font-weight: bold;">è¨Šæ¯</p><div id="select-card-container" style="display: flex; justify-content: center; flex-wrap:wrap; gap: 15px; margin: 20px 0; min-height: 150px;"></div></div></div>
    
    <div id="exchange-card-modal" class="modal"><div class="modal-content exchange-selection-area" style="max-width: 700px; text-align: center;"><h3>ğŸ“ <span id="exchange-main-title">é¸æ“‡æ›ç‰Œ</span></h3><p style="color: #7f8c8d; font-size: 12px;" id="exchange-modal-desc">è«‹å„é»æ“Šé¸æ“‡ä¸€å¼µå¡ç‰Œé€²è¡Œäº¤æ›</p><div style="display: flex; justify-content: space-between; gap: 20px;"><div style="flex: 1; border: 2px dashed #e74c3c; padding: 10px; border-radius: 8px; background: #fdedec;"><h4 style="margin-top:0; color:#c0392b;" id="exchange-left-title">1. ä½ çš„æ‰‹ç‰Œ</h4><div id="exchange-hand-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;"></div></div><div id="exchange-right-panel" style="flex: 1; border: 2px dashed #3498db; padding: 10px; border-radius: 8px; background: #eafaf1;"><h4 style="margin-top:0; color:#2980b9;" id="exchange-target-title">2. ç›®æ¨™å¡ç‰Œ</h4><div id="exchange-discard-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;"></div></div></div><div style="margin-top: 20px;"><button class="btn-action" style="background:#3498db; font-size:18px; padding: 10px 40px;" onclick="confirmExchange()">ç¢ºå®šé¸æ“‡</button><button class="btn-action" style="background:#95a5a6; font-size:14px; padding: 10px 20px;" onclick="cancelExchange()">å–æ¶ˆ</button></div></div></div>

    <div id="game-wrapper">
        <div id="opponents-container"></div>

        <div id="center-zone">
            <div id="event-timer-box">â³ ä¸‹æ¬¡çªç™¼äº‹ä»¶ï¼š<span id="event-countdown" style="color:#f1c40f; font-size:18px;"></span> è¼ªå¾Œ</div>
            <div id="turn-announcement" style="font-size: 18px; font-weight: bold; color: #e67e22; letter-spacing: 1px;">æº–å‚™é–‹å§‹...</div>
            <div id="discard-pile" onclick="showDiscardModal()">ğŸ—‘ï¸ é†«å­¸æ£„ç‰Œå€</div>
        </div>

        <div id="player-zone">
            <div id="table-cards-container">
                <h2 style="text-align: left; margin-left: 10px;">ğŸ›ï¸ ä½ çš„ç—…åºŠå€ (å·²æ”¶æ²»)</h2>
                <div id="table-cards" class="hand-container">ç›®å‰ç„¡ç—…äººæ”¶æ²»</div>
            </div>

            <div class="control-bar">
                <button id="draw-btn" class="btn-action" onclick="drawMedicalCard()">ğŸ“¦ 1. æŠ½ç‰Œ <span id="med-deck-count" style="font-size:11px; font-weight:normal;"></span></button>
                <button id="guide-btn" class="btn-action" onclick="showGuideModal()">ğŸ“– è‡¨åºŠæŒ‡å¼•</button>
                <button id="admit-btn" class="btn-action" onclick="admitPatient()">ğŸ©º 2. å®£å‘Šæ”¶æ²»</button>
                <button id="discard-btn" class="btn-action" onclick="discardCard()">ğŸ—‘ï¸ 3. æ£„ç‰Œ (è¶…éä¸Šé™æ™‚)</button>
                <button id="end-btn" class="btn-action" onclick="endTurn()">â¡ï¸ 4. çµæŸå›åˆ</button>
            </div>
            
            <div id="dual-hand-zone">
                <div id="med-hand-col" class="hand-column">
                    <h3 class="hand-column-title">
                        <span>ğŸ©º ä½ çš„é†«å­¸æ‰‹ç‰Œ <span id="medical-count-display"></span> <span id="dnr-status" style="color:#ff7675; font-size:12px;"></span></span>
                        <span style="font-size: 11px; font-weight: normal; color: #bdc3c7;">(å¯æ‹–æ›³æ’åº)</span>
                    </h3>
                    <div id="hand-cards" class="hand-container"></div>
                </div>

                <div id="act-hand-col" class="hand-column">
                    <h3 class="hand-column-title" style="background: #c0392b;">
                        <span>ğŸ“± åŠŸèƒ½æ‰‹ç‰Œ <span id="action-count-display"></span></span>
                        <span style="font-size: 11px; font-weight: normal; color: #bdc3c7;">(ç‰Œåº«å‰© <span id="act-deck-count"></span> å¼µ)</span>
                    </h3>
                    <div id="action-hand-cards" class="hand-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function generateImgHtml(card) {
            let defaultEmoji = "ğŸ’Š";
            if(card.type === "CC") defaultEmoji = "ğŸ¤•";
            if(card.type === "Sx") defaultEmoji = "ğŸ”¬";
            if(card.type === "Dx") defaultEmoji = "ğŸ“‹";
            if(card.type === "Tx") defaultEmoji = "ğŸ’‰";
            if(card.type === "Wildcard") defaultEmoji = "ğŸƒ";
            if(card.type === "Action") defaultEmoji = "âš¡";
            
            return `
            <div class="card-img-container">
                <span class="fallback-icon">${defaultEmoji}</span>
                <img src="${card.img}" onerror="this.style.display='none'">
            </div>`;
        }

        function showToast(msg) {
            let container = document.getElementById("toast-container");
            let toast = document.createElement("div");
            toast.className = "toast"; toast.innerHTML = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function showTutorialModal() {
            document.getElementById("tutorial-modal").style.display = "block";
        }

        // ğŸŒŸ å»¶é•·å‹•ç•«æ™‚é–“ç‚º 3.5 ç§’
        function playCinematicAsync(card, userName, msg) {
            return new Promise(resolve => {
                let overlay = document.getElementById("cinematic-overlay");
                let content = document.getElementById("cinematic-content");
                let imgHtml = generateImgHtml(card);
                
                content.innerHTML = `
                    <div class="card type-Action cinematic-card-display" style="width: 130px; padding: 10px;">
                        ${imgHtml}
                        <div class="card-title" style="font-size: 18px; color: #000; margin-bottom: 5px;">${card.name}</div>
                        <div class="card-type-badge" style="font-size:12px; margin-bottom:5px;">ç‹€æ…‹ç‰Œ</div>
                        <div class="action-desc" style="font-size: 11px; color: #c0392b;">${card.desc}</div>
                    </div>
                    <div class="cinematic-text">
                        ${userName}<br>
                        <span style="font-size:42px; color:#f1c40f;">${msg}</span>
                    </div>
                `;
                overlay.style.display = "flex";
                setTimeout(() => {
                    overlay.style.display = "none";
                    resolve();
                }, 3500); 
            });
        }

        const typeMap = { "CC": "ä¸»è¨´", "Sx": "ç—‡ç‹€", "Dx": "è¨ºæ–·", "Tx": "æ²»ç™‚", "Wildcard": "æœƒè¨ºå–®", "Action": "åŠŸèƒ½ç‰Œ" };
        const validRecipes = [
            { name: "è…ç—…ç—‡å€™ç¾¤", cc: ["ä¸‹è‚¢æ°´è…«"], sx: ["è›‹ç™½å°¿"], dx: ["è…ç—…ç—‡å€™ç¾¤"], tx: ["é¡å›ºé†‡"] },
            { name: "æ€¥æ€§è…æå‚·(AKI)", cc: ["å¯¡å°¿", "ä¸‹è‚¢æ°´è…«"], sx: ["EGFRé©Ÿé™"], dx: ["æ€¥æ€§è…æå‚·(AKI)"], tx: ["è¡€æ¶²é€æ"] },
            { name: "æ€¥æ€§å¿ƒè‚Œæ¢—å¡", cc: ["èƒ¸ç—›"], sx: ["STæ®µä¸Šå‡"], dx: ["æ€¥æ€§å¿ƒè‚Œæ¢—å¡(AMI)"], tx: ["å¿ƒå°ç®¡ä»‹å…¥", "ç¡é…¸ç”˜æ²¹"] },
            { name: "é¬±è¡€æ€§å¿ƒè¡°ç«­", cc: ["å–˜", "ä¸‹è‚¢æ°´è…«"], sx: ["é ¸éœè„ˆæ€’å¼µ"], dx: ["é¬±è¡€æ€§å¿ƒè¡°ç«­(CHF)"], tx: ["åˆ©å°¿åŠ‘", "ç¡é…¸ç”˜æ²¹"] },
            { name: "æ°£é“é˜»å¡", cc: ["å–˜"], sx: ["è‚ºéƒ¨å–˜é³´è²"], dx: ["COPDæ€¥æ€§ç™¼ä½œ", "æ°£å–˜æ€¥æ€§ç™¼ä½œ"], tx: ["æ°£ç®¡æ“´å¼µåŠ‘"] },
            { name: "åš´é‡è‚ºç‚", cc: ["ç™¼ç‡’", "å–˜"], sx: ["è‚ºéƒ¨æµ¸æ½¤", "è‚ºéƒ¨æ¿•é‘¼éŸ³"], dx: ["è‚ºç‚"], tx: ["æŠ—ç”Ÿç´ "] },
            { name: "æ€¥æ€§è…¹ç—‡", cc: ["è…¹ç—›", "ç™¼ç‡’"], sx: ["è…¹éƒ¨å£“ç—›"], dx: ["è†½å›Šç‚", "é—Œå°¾ç‚"], tx: ["ç…§æœƒä¸€èˆ¬å¤–ç§‘", "æŠ—ç”Ÿç´ "] },
            { name: "è‚ç¡¬åŒ–åˆä½µè…¹æ°´", cc: ["ä¸‹è‚¢æ°´è…«"], sx: ["è…¹æ°´"], dx: ["è‚ç¡¬åŒ–"], tx: ["æŠ½è…¹æ°´", "åˆ©å°¿åŠ‘"] }
        ];

        // ğŸŒŸ å¯¦è£ç²¾ç¢ºæ•¸é‡çš„é†«å­¸ç‰Œåº« (ç¸½æ•¸ 131 å¼µ)
        const medicalDeckBlueprint = [
            { type: "CC", name: "ä¸‹è‚¢æ°´è…«", count: 7, img: "images/cc_edema.png" }, 
            { type: "CC", name: "å–˜", count: 6, img: "images/cc_dyspnea.png" }, 
            { type: "CC", name: "ç™¼ç‡’", count: 4, img: "images/cc_fever.png" }, 
            { type: "CC", name: "å¯¡å°¿", count: 3, img: "images/cc_oliguria.png" }, 
            { type: "CC", name: "èƒ¸ç—›", count: 3, img: "images/cc_chestpain.png" }, 
            { type: "CC", name: "è…¹ç—›", count: 3, img: "images/cc_abdpain.png" },
            
            { type: "Sx", name: "è›‹ç™½å°¿", count: 4, img: "images/sx_proteinuria.png" }, 
            { type: "Sx", name: "EGFRé©Ÿé™", count: 4, img: "images/sx_egfr.png" }, 
            { type: "Sx", name: "STæ®µä¸Šå‡", count: 4, img: "images/sx_st.png" }, 
            { type: "Sx", name: "é ¸éœè„ˆæ€’å¼µ", count: 4, img: "images/sx_jvd.png" }, 
            { type: "Sx", name: "è‚ºéƒ¨å–˜é³´è²", count: 4, img: "images/sx_wheezing.png" }, 
            { type: "Sx", name: "è‚ºéƒ¨æµ¸æ½¤", count: 4, img: "images/sx_infiltration.png" }, 
            { type: "Sx", name: "è‚ºéƒ¨æ¿•é‘¼éŸ³", count: 4, img: "images/sx_rales.png" }, 
            { type: "Sx", name: "è…¹éƒ¨å£“ç—›", count: 4, img: "images/sx_tenderness.png" }, 
            { type: "Sx", name: "è…¹æ°´", count: 4, img: "images/sx_ascites.png" },
            
            { type: "Dx", name: "è…ç—…ç—‡å€™ç¾¤", count: 3, img: "images/dx_ns.png" }, 
            { type: "Dx", name: "æ€¥æ€§è…æå‚·(AKI)", count: 3, img: "images/dx_aki.png" }, 
            { type: "Dx", name: "æ€¥æ€§å¿ƒè‚Œæ¢—å¡(AMI)", count: 3, img: "images/dx_ami.png" }, 
            { type: "Dx", name: "é¬±è¡€æ€§å¿ƒè¡°ç«­(CHF)", count: 3, img: "images/dx_chf.png" }, 
            { type: "Dx", name: "COPDæ€¥æ€§ç™¼ä½œ", count: 3, img: "images/dx_copd.png" }, 
            { type: "Dx", name: "æ°£å–˜æ€¥æ€§ç™¼ä½œ", count: 3, img: "images/dx_asthma.png" }, 
            { type: "Dx", name: "è‚ºç‚", count: 3, img: "images/dx_pneumonia.png" }, 
            { type: "Dx", name: "è†½å›Šç‚", count: 3, img: "images/dx_cholecystitis.png" }, 
            { type: "Dx", name: "é—Œå°¾ç‚", count: 3, img: "images/dx_appendicitis.png" }, 
            { type: "Dx", name: "è‚ç¡¬åŒ–", count: 3, img: "images/dx_cirrhosis.png" },
            
            { type: "Tx", name: "æŠ—ç”Ÿç´ ", count: 5, img: "images/tx_antibiotics.png" }, 
            { type: "Tx", name: "ç¡é…¸ç”˜æ²¹", count: 5, img: "images/tx_ntg.png" }, 
            { type: "Tx", name: "åˆ©å°¿åŠ‘", count: 5, img: "images/tx_diuretic.png" }, 
            { type: "Tx", name: "é¡å›ºé†‡", count: 3, img: "images/tx_steroid.png" }, 
            { type: "Tx", name: "è¡€æ¶²é€æ", count: 3, img: "images/tx_hemo.png" }, 
            { type: "Tx", name: "å¿ƒå°ç®¡ä»‹å…¥", count: 3, img: "images/tx_pci.png" }, 
            { type: "Tx", name: "æ°£ç®¡æ“´å¼µåŠ‘", count: 3, img: "images/tx_bronchodilator.png" }, 
            { type: "Tx", name: "ç…§æœƒä¸€èˆ¬å¤–ç§‘", count: 3, img: "images/tx_gs.png" }, 
            { type: "Tx", name: "æŠ½è…¹æ°´", count: 3, img: "images/tx_paracentesis.png" },
            
            { type: "Wildcard", name: "æœƒè¨ºå–®", count: 8, img: "images/act_wildcard.png" }
        ];

        // ğŸŒŸ å¯¦è£ç²¾ç¢ºæ•¸é‡çš„åŠŸèƒ½ç‰Œåº« (ç¸½æ•¸ 54 å¼µ)
        const actionDeckBlueprint = [
            { type: "Action", name: "Callä¸Šç·š", desc: "æª¢è¦–é ‚ç«¯3å¼µé¸1å¼µåŠ å…¥ï¼Œå…¶é¤˜æ´—å›", effectId: "call", cat: "buff", count: 4, img: "images/act_call.png" },
            { type: "Action", name: "Combine", desc: "æª¢è¦–é ‚ç«¯2å¼µé¸1å¼µåŠ å…¥ï¼Œå¦1å¼µæ£„ç½®", effectId: "combine", cat: "buff", count: 4, img: "images/act_combine.png" },
            { type: "Action", name: "è£œç—…æ­·", desc: "æ£„ç½®1å¼µæ‰‹ç‰Œï¼Œæ’¿å›2å›åˆå…§1å¼µæ£„ç‰Œ", effectId: "chart", cat: "buff", count: 4, img: "images/act_chart.png" },
            { type: "Action", name: "æˆ‘æ„›åŠ ç­", desc: "æ£„1å¼µé†«å­¸ç‰Œï¼ŒæŒ‡å®šæŠ½å– CC/Sx/Dx/Tx ç‰Œ", effectId: "duty", cat: "buff", count: 4, img: "images/act_duty.png" },
            
            { type: "Action", name: "Seminar", desc: "ä½ çš„é†«å­¸ç‰Œä¸Šé™+1", effectId: "seminar", cat: "buff", count: 3, img: "images/act_seminar.png" },
            { type: "Action", name: "å ± Case", desc: "ä½¿æŒ‡å®šå°æ‰‹çš„æ‰‹ç‰Œå‘æ‰€æœ‰äººå…¬é–‹ä¸€å›åˆ", effectId: "report", cat: "attack", count: 3, img: "images/act_report.png" }, 
            { type: "Action", name: "åˆ†å¥´", desc: "æŒ‡å®šå°æ‰‹æ£„ç½®ä¸€å¼µä¸»è¨´(CC)ç‰Œï¼Œå°æ‰‹å†æŠ½1å¼µ", effectId: "tryhard", cat: "attack", count: 3, img: "images/act_tryhard.png" },
            { type: "Action", name: "æŠ„æ¨¡æ¿", desc: "å’ŒæŒ‡å®šå°æ‰‹å„è‡ªé¸æ“‡ä¸€å¼µé†«å­¸ç‰Œäº’æ›", effectId: "copy", cat: "attack", count: 3, img: "images/act_copy.png" },
            { type: "Action", name: "æ›ç§‘", desc: "æ‰€æœ‰ç©å®¶å°‡åŠŸèƒ½ç‰Œæ´—å›ç‰Œåº«ï¼Œé‡æ–°æŠ½å–ç­‰é‡å¡ç‰Œ", effectId: "shift", cat: "global", count: 3, img: "images/act_shift.png" }, 
            { type: "Action", name: "é¸ç§‘", desc: "æ¯ä½ç©å®¶æŠ½1å¼µé†«å­¸ç‰Œï¼Œç„¶å¾Œéš¨æ©Ÿæ£„ç½®1å¼µ", effectId: "choose", cat: "global", count: 3, img: "images/act_choose.png" },
            { type: "Action", name: "PM OFF", desc: "æŠµéŠ·æ”»æ“Šï¼Œé›™æ–¹å„æŠ½ä¸€å¼µé†«å­¸ç‰Œ", effectId: "pmoff", cat: "defend", count: 3, img: "images/act_pmoff.png" },
            { type: "Action", name: "äº¤ç­", desc: "å—åˆ°æ”»æ“Šæ™‚ï¼ŒæŠŠæ”»æ“Šç›´æ¥è½‰ç§»çµ¦ä¸‹ä¸€å®¶", effectId: "transfer", cat: "defend", count: 3, img: "images/act_transfer.png" }, 
            { type: "Action", name: "æ•´é “è·å ´", desc: "å—åˆ°æ”»æ“Šæ™‚ï¼ŒæŠŠæ”»æ“Šç›´æ¥åå½ˆäºˆæ”»æ“Šè€…", effectId: "reflect", cat: "defend", count: 3, img: "images/act_reflect.png" },

            { type: "Action", name: "ç°½ç½² DNR", desc: "å…¶ä¸­ä¸€å€‹ Caseï¼Œä¸ç”¨ Tx å³å¯å®Œæˆ", effectId: "dnr", cat: "buff", count: 2, img: "images/act_dnr.png" },
            { type: "Action", name: "å¥ä¿æ ¸åˆª", desc: "æ‹”é™¤å°æ‰‹å·²å®Œæˆ Case çš„æ²»ç™‚ç‰Œä¸Ÿæ£„", effectId: "audit", cat: "attack", count: 2, img: "images/act_audit.png" },
            // ğŸŒŸ å°‡å¤§æ··äº‚æ”¹ç‚º 1 å¼µ
            { type: "Action", name: "å¤§æ··äº‚", desc: "æ‰€æœ‰äººä¸Ÿæ£„å’Œä½ ç›®å‰æ‰‹ç‰Œç­‰é‡çš„é†«å­¸ç‰Œå¾Œé‡æŠ½", effectId: "chaos", cat: "global", count: 1, img: "images/act_chaos.png" },
            { type: "Action", name: "æˆ‘æœ‰BG", desc: "é¸æ“‡å°æ‰‹ï¼Œè‡ªå·±æŠ½åŠŸèƒ½ç‰Œç›´åˆ°æ•¸é‡èˆ‡ä»–ç›¸åŒ", effectId: "bg", cat: "buff", count: 2, img: "images/act_bg.png" },
            { type: "Action", name: "æ ¸å¿ƒèª²ç¨‹", desc: "é¸æ“‡ä¸€åå°æ‰‹ï¼Œä½¿å…¶ä¸‹ä¸€å›åˆå¼·åˆ¶è¢«è·³é", effectId: "skip", cat: "attack", count: 2, img: "images/act_skip.png" },
            { type: "Action", name: "ä»Šå¤©æ²’äº‹", desc: "é¦¬ä¸Šè§¸ç™¼å…¨é™¢äº‹ä»¶ï¼Œä¸¦é‡ç½®äº‹ä»¶å€’æ•¸æ™‚é–“", effectId: "flag", cat: "global", count: 2, img: "images/act_flag.png" }
        ];

        const eventDB = [
            { id: "chest", name: "ğŸ« èƒ¸è…”å…§ç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šç—…æˆ¿ Code Blueï¼Œç·Šæ€¥æ’ç®¡ï¼ã€‘", color: "rgba(41, 128, 185, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šç—…äººå–˜ä¸éæ°£ã€è¡€æ°§æ‰åˆ° 70%ï¼Œå…¨ç—…æˆ¿çš„é†«å¸«éƒ½æ¨è‘—æ€¥æ•‘è»Šè¡éå»ï¼Œæ ¹æœ¬æ²’ç©ºé–‹å¸¸è¦è—¥ç‰©ã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€å‘¼å¸è¡°ç«­ã€‘ã€‚æœ¬å›åˆå…§ï¼Œæ‰€æœ‰ç©å®¶ç¦æ­¢æ‰“å‡ºä»»ä½•ã€Œæ²»ç™‚ (Tx)ã€ç‰Œã€‚",
              reward: "ç²å¾—ç‰¹æ¬Šï¼Œç„¡è¦–å…¨å ´æ•ˆæœï¼Œä¸”ç«‹åˆ»å¾é†«å­¸æ£„ç‰Œå€æŠ½å– 1 å¼µã€Œæ²»ç™‚ (Tx)ã€æˆ–ã€Œè¨ºæ–· (Dx)ã€åŠ å…¥æ‰‹ç‰Œ (è‹¥ç„¡å‰‡æŠ½ç‰Œåº«)ã€‚",
              penalty: "ä½ å¿…é ˆå¼·åˆ¶ä¸Ÿæ£„æ‰‹ç‰Œä¸­çš„ 1 å¼µã€Œæ²»ç™‚ (Tx)ã€ï¼Œè‹¥æ²’æœ‰å‰‡éš¨æ©Ÿç›²ä¸Ÿ 1 å¼µé†«å­¸ç‰Œã€‚",
              qs: [
                  {q:"ä¸€ä½é•·æœŸæŠ½è¸çš„ç”·æ€§å› å’³å—½å°±é†«ï¼Œå½±åƒå­¸ç™¼ç¾è‚ºéƒ¨ä¸­å¤®æœ‰è…«ç˜¤ä¸¦ä¼´éš¨ç©ºæ´åŒ–ã€‚æŠ½è¡€æª¢æŸ¥ç™¼ç¾æœ‰é«˜è¡€éˆ£ï¼Œè«‹å•æœ€å¯èƒ½æ˜¯ä¸‹åˆ—å“ªä¸€ç¨®è‚ºç™Œï¼Ÿ", opts:["A. è‚ºè…ºç™Œ","B. é±—ç‹€ä¸Šçš®ç™Œ","C. å°ç´°èƒè‚ºç™Œ"], ans:1},
                  {q:"é‡å°æ™šæœŸè‚ºè…ºç™Œæ‚£è€…ï¼Œè‹¥ç¬¬ä¸€ç·šä½¿ç”¨ EGFR TKI å¾Œç”¢ç”ŸæŠ—è—¥æ€§ï¼Œä¸”åŸºå› æª¢æ¸¬ç™¼ç¾ T790M çªè®Šï¼Œæ‡‰å„ªå…ˆè€ƒæ…®æ”¹ç”¨å“ªä¸€ç¨®æ¨™é¶è—¥ç‰©ï¼Ÿ", opts:["A. Gefitinib","B. Crizotinib","C. Osimertinib"], ans:2},
                  {q:"ä¸€ä½é•·æœŸæŠ½è¸çš„65æ­²ç”·æ€§ï¼Œå› æ¼¸é€²æ€§å‘¼å¸å›°é›£å°±é†«ã€‚ä¸‹åˆ—ä½•é …æ•¸å€¼æ˜¯è¨ºæ–·ç‚º COPD çš„é»ƒé‡‘æ¨™æº–ï¼Ÿ", opts:["A. æ”¯æ°£ç®¡æ“´å¼µåŠ‘å‰ FEV1 < 80%","B. æ”¯æ°£ç®¡æ“´å¼µåŠ‘å¾Œ FEV1/FVC < 0.70","C. æ”¯æ°£ç®¡æ“´å¼µè©¦é©— FEV1 å¢åŠ  > 12%"], ans:1}
              ]
            },
            { id: "cv", name: "ğŸ«€ å¿ƒè‡Ÿè¡€ç®¡å…§ç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šæ€¥è¨º STEMIï¼Œç«‹åˆ»å•Ÿå‹•å¿ƒå°ç®¡ï¼ã€‘", color: "rgba(192, 57, 43, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šTime is muscleï¼å¿ƒé›»åœ–ä¸€æ‹‰å‡ºä¾†ç›´æ¥é£›å¤©ï¼Œä¸»æ²»é†«å¸«åœ¨ç¾¤çµ„ç‹‚å¼ï¼Œå…¨é™¢ç¯€å¥ç¬é–“æ‹‰åˆ°æœ€å¿«ã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€å¿ƒè·³ç‹‚é£†ã€‘ã€‚å…¨å ´ç©å®¶å¼·åˆ¶é€²è¡Œã€Œæ€¥é€Ÿäº¤ç­ã€ï¼Œæ¯å€‹äººå¿…é ˆç«‹åˆ»éš¨æ©Ÿç›²ä¸Ÿ 1 å¼µé†«å­¸ç‰Œï¼Œç„¶å¾Œé‡æŠ½ 1 å¼µã€‚",
              reward: "ç²¾æº–æŠ“åˆ°å¿ƒé›»åœ–è®ŠåŒ–ï¼ä½ åœ¨æ€¥é€Ÿäº¤ç­ä¸­ï¼Œå†å¤šæŠ½ 1 å¼µé†«å­¸ç‰Œã€‚",
              penalty: "ç—…äººå¿ƒå¾‹ä¸æ•´ã€‚åœ¨ä½ çš„ä¸‹å€‹å›åˆï¼Œå¼·åˆ¶è·³éã€Œä¸‹ Orderã€ï¼ˆä¸èƒ½æ‰“åŠŸèƒ½ç‰Œã€ä¸èƒ½æ”¶æ²»ï¼‰ã€‚",
              qs: [
                  {q:"55æ­²ç”·æ€§çªç™¼åŠ‡çƒˆèƒ¸ç—›ï¼Œå¿ƒé›»åœ–å°ç¨‹ II, III, aVF æœ‰ ST æ®µä¸Šå‡ï¼Œæ‡·ç–‘ä¸‹å£å¿ƒè‚Œæ¢—å¡ã€‚æ­¤ç—…äººæœ€ä¸é©åˆä½¿ç”¨ä¸‹åˆ—å“ªä¸€ç¨®è—¥ç‰©ï¼Ÿ", opts:["A. Aspirin","B. Nitrates","C. Clopidogrel"], ans:1},
                  {q:"ä¸‹åˆ—ä½•ç¨®æ²»ç™‚å¿ƒè‡Ÿè¡°ç«­çš„è—¥ç‰©ï¼Œåƒ…èƒ½æ”¹å–„ç—‡ç‹€èˆ‡é™ä½ä½é™¢ç‡ï¼Œä½†ç„¡æ³•é™ä½æ­»äº¡ç‡ï¼Ÿ", opts:["A. Spironolactone","B. Digoxin (æ¯›åœ°é»ƒ)","C. Dapagliflozin"], ans:1},
                  {q:"HFrEF ç—…æ‚£é–‹å§‹ä½¿ç”¨ ARNI æ²»ç™‚ã€‚è¿½è¹¤æŠ½è¡€æ•¸æ“šæ™‚ï¼Œä¸‹åˆ—ä½•é …æŒ‡æ¨™æœƒå› ç‚ºè—¥æ•ˆè€Œå‡æ€§å‡é«˜ï¼Œä¸é©åˆç”¨ä¾†è¿½è¹¤æƒ¡åŒ–ï¼Ÿ", opts:["A. BNP","B. NT-proBNP","C. Troponin I"], ans:0}
              ]
            },
            { id: "nephro", name: "ğŸ©¸ è…è‡Ÿç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šK é›¢å­ 7.8ï¼Œç·Šæ€¥æ´—è…ï¼ã€‘", color: "rgba(139, 0, 0, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šé›»è§£è³ªå¾¹åº•å´©æ½°ï¼Œç—…äººéš¨æ™‚æœƒ VT/VFï¼Œå¿…é ˆåš´æ ¼æ§åˆ¶æ°´åˆ†å’Œé£²é£Ÿï¼Œæ‰€æœ‰äººçš„è³‡æºéƒ½è¢«é™ç¸®ã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€é™æ°´é™é‰€ã€‘ã€‚å…¨å ´ç©å®¶çš„é†«å­¸ç‰Œã€Œæ‰‹ç‰Œä¸Šé™ã€åœ¨ä¸‹ä¸€å›åˆå¼·åˆ¶ç¸®æ¸›ç‚º 5 å¼µã€‚è¶…éè€…ç«‹åˆ»ä¸Ÿç‰Œã€‚",
              reward: "ä½ å…ç–«æ‰‹ç‰Œç¸®æ¸›æ•ˆæœï¼ˆç¶­æŒåŸä¸Šé™ï¼‰ï¼Œä¸¦å¯å¾åŠŸèƒ½ç‰Œå †å…è²»æŠ½ 1 å¼µç‰Œã€‚",
              penalty: "ä½ é™¤äº†è¦éµå®ˆ 5 å¼µæ‰‹ç‰Œé™åˆ¶ï¼Œé‚„å¿…é ˆç«‹åˆ»å†ç›²ä¸Ÿæ£„ 1 å¼µæ‰‹ä¸Šçš„é†«å­¸ç‰Œã€‚",
              qs: [
                  {q:"ä¸€ä½æ…¢æ€§è…è‡Ÿç—…æ‚£è€…å› åš´é‡é«˜è¡€é‰€ï¼ˆK+ = 7.2 mEq/Lï¼‰é€æ€¥è¨ºï¼Œå¿ƒé›»åœ–é¡¯ç¤º QRS æ³¢è®Šå¯¬ã€‚æ­¤æ™‚æœ€å„ªå…ˆçµ¦äºˆçš„æ€¥æ•‘è—¥ç‰©ç‚ºä½•ï¼Ÿ", opts:["A. Insulin (RI) + Glucose (D50W)","B. Calcium gluconate (è‘¡è„ç³–é…¸éˆ£)","C. Furosemide (Loop diuretics)"], ans:1},
                  {q:"ä¸€ä½å¹´è¼•æ‚£è€…å› åè¦†è‚Œè‚‰ç„¡åŠ›å°±é†«ï¼ŒæŠ½è¡€ç™¼ç¾ä½è¡€é‰€ã€ä»£è¬æ€§é¹¼ä¸­æ¯’ä¸”è¡€å£“æ­£å¸¸ã€‚æª¢é©—é¡¯ç¤ºå°¿éˆ£é¡¯è‘—é™ä½ä¸”åˆä½µä½è¡€é‚ã€‚æœ€å¯èƒ½çš„è¨ºæ–·ç‚ºä½•ï¼Ÿ", opts:["A. åŸç™¼æ€§é†›å›ºé…®éå¤šç—‡","B. Bartter's syndrome","C. Gitelman's syndrome"], ans:2},
                  {q:"åœ¨å„ç¨®è…å°ç®¡é…¸è¡€ç—‡ (RTA) ä¸­ï¼Œä¸‹åˆ—å“ªä¸€å‹å…¸å‹æœƒåˆä½µã€Œé«˜è¡€é‰€ (Hyperkalemia)ã€ï¼Ÿ", opts:["A. ç¬¬ä¸€å‹é ç«¯ RTA","B. ç¬¬äºŒå‹è¿‘ç«¯ RTA","C. ç¬¬å››å‹ RTA"], ans:2},
                  {q:"é‡å°é«˜é¢¨éšªç—…æ‚£ï¼Œåœ¨æ¥å—å«ç¢˜é¡¯å½±åŠ‘çš„é›»è…¦æ–·å±¤æª¢æŸ¥å‰ï¼Œä¸‹åˆ—ä½•è€…æ˜¯é é˜²é¡¯å½±åŠ‘è…ç—…è®Šæœ€é¦–é¸ä¸”æœ‰æ•ˆçš„æ–¹æ³•ï¼Ÿ", opts:["A. çµ¦äºˆç­‰å¼µç”Ÿç†é£Ÿé¹½æ°´éœè„ˆè¼¸æ¶²","B. æª¢æŸ¥å‰é é˜²æ€§å®‰æ’è¡€æ¶²é€æ","C. å–®ç¨çµ¦äºˆé«˜åŠ‘é‡åˆ©å°¿åŠ‘"], ans:0},
                  {q:"è‡ªé«”é¡¯æ€§å¤šå›Šæ€§è…ç—… (ADPKD) æ‚£è€…é™¤äº†è…è‡Ÿå›Šæ³¡å¤–ï¼Œä¹Ÿå¸¸åˆä½µå…¶ä»–å™¨å®˜çš„ç•°å¸¸ã€‚ä¸‹åˆ—ä½•è€…æ˜¯å…¶æœ€å¸¸è¦‹çš„è…å¤–è¡¨ç¾ï¼Ÿ", opts:["A. é¡±å…§å‹•è„ˆç˜¤","B. è‚å›Šè…«","C. äºŒå°–ç“£è„«å‚"], ans:1}
              ]
            },
            { id: "id", name: "ğŸ¦  æ„ŸæŸ“ç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šçˆ†ç™¼é™¢å…§æŠ—è—¥æ€§è¶…ç´šç´°èŒ (CRAb)ï¼ã€‘", color: "rgba(39, 174, 96, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šæ„Ÿæ§ä¸­å¿ƒä¸‹é”éµè…•æ”¿ç­–ï¼Œå…¨ç—…æˆ¿åš´æ ¼éš”é›¢ç©¿å…”å¯¶å¯¶è£ï¼Œå„ç§‘ä¹‹é–“çš„äº¤æµèˆ‡ç—…äººè½‰åºŠå…¨é¢åœæ“ºã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€åš´æ ¼éš”é›¢ã€‘ã€‚å…¨å ´ç©å®¶åœ¨ä¸‹æ¬¡å›åˆå‰ï¼Œéƒ½ç„¡æ³•ä½¿ç”¨ã€Œæœƒè¨ºå–®ã€æˆ–ã€ŒåŠŸèƒ½ç‰Œã€ã€‚",
              reward: "ä½ ç„¡è¦–éš”é›¢è¦å®šï¼Œä¸‹ä¸€å›åˆä»ç„¶å¯ä»¥è‡ªç”±ä½¿ç”¨æœƒè¨ºå–®èˆ‡åŠŸèƒ½ç‰Œã€‚",
              penalty: "ä½ å¿…é ˆå¼·åˆ¶å°‡æ‰‹ä¸Šçš„ 1 å¼µã€Œæœƒè¨ºå–®ã€æˆ–ã€ŒåŠŸèƒ½ç‰Œã€ä¸Ÿå…¥æ£„ç‰Œå€ï¼Œæ²’æœ‰å‰‡ç›²ä¸Ÿä¸€å¼µé†«å­¸ç‰Œã€‚",
              qs: [
                  {q:"ä¸€ä½æœ‰éœè„ˆè—¥ç™® (IVDU) ç—…å²çš„æ‚£è€…å› ç™¼ç‡’æ±‚è¨ºï¼Œè¡€æ¶²åŸ¹é¤Šé•·å‡ºé‡‘é»ƒè‰²è‘¡è„çƒèŒã€‚å…¶æ„ŸæŸ“æ€§å¿ƒå…§è†œç‚æœ€å¸¸ä¾µçŠ¯å“ªä¸€å€‹å¿ƒè‡Ÿç“£è†œï¼Ÿ", opts:["A. ä¸»å‹•è„ˆç“£","B. äºŒå°–ç“£","C. ä¸‰å°–ç“£"], ans:2},
                  {q:"ä¸€ä½ 60 æ­²å¥åº·ç”·æ€§çªç™¼ç™¼ç‡’ã€é ­ç—›åŠé ¸éƒ¨åƒµç¡¬é€æ€¥è¨ºï¼Œè…°æ¤ç©¿åˆºé¡¯ç¤ºç´°èŒæ€§è…¦è†œç‚ã€‚åœ¨ç­‰å¾…åŸ¹é¤Šçµæœå‰ï¼Œæœ€é©åˆçš„ç¶“é©—æ€§æŠ—ç”Ÿç´ çµ„åˆç‚ºä½•ï¼Ÿ", opts:["A. Ceftriaxone + Vancomycin + Ampicillin","B. Ceftriaxone + Vancomycin","C. Cefepime + Metronidazole"], ans:0},
                  {q:"çµæ ¸ç—…æ‚£è€…æ¥å—ç¬¬ä¸€ç·šæŠ—çµæ ¸è—¥ç‰© (RIPE) æ²»ç™‚å¾Œï¼Œä¸»è¨´å°¿æ¶²åŠçœ¼æ·šè®Šæˆæ©˜ç´…è‰²ã€‚æ­¤ç¾è±¡æœ€å¯èƒ½æ˜¯ä¸‹åˆ—å“ªä¸€ç¨®è—¥ç‰©å¼•èµ·ï¼Ÿ", opts:["A. Isoniazid (INH)","B. Rifampin (RMP)","C. Pyrazinamide (PZA)"], ans:1},
                  {q:"ä¸€ä½å¾å°åº¦è¿”åœ‹çš„æ—…å®¢å‡ºç¾æŒçºŒé«˜ç‡’ã€ç›¸å°æ€§å¿ƒè·³éæ…¢åŠè…¹éƒ¨ç«ç‘°ç–¹ï¼Œè¡€æ¶²åŸ¹é¤Šé•·å‡ºæ²™é–€æ°æ¡¿èŒ (Salmonella Typhi)ã€‚æ­¤ç–¾ç—…æœ€å¸¸æ½›ä¼æ–¼å“ªä¸€å€‹å™¨å®˜ï¼Ÿ", opts:["A. è‚è‡Ÿ","B. è†½å›Š","C. è„¾è‡Ÿ"], ans:1},
                  {q:"é‡å°ä¸­å¿ƒéœè„ˆå°ç®¡ç›¸é—œè¡€æµæ„ŸæŸ“ (CRBSI)ï¼Œè‹¥è¡€æ¶²åŸ¹é¤Šçµæœç‚ºä¸‹åˆ—ä½•ç¨®ç´°èŒï¼Œå¼·çƒˆå»ºè­°å¿…é ˆç§»é™¤å°ç®¡ï¼Ÿ", opts:["A. è¡¨çš®è‘¡è„çƒèŒ","B. å‡å›ºé…¶é™°æ€§è‘¡è„çƒèŒ (CoNS)","C. é‡‘é»ƒè‰²è‘¡è„çƒèŒ"], ans:2}
              ]
            },
            { id: "rheuma", name: "ğŸ¦‹ é¢¨æ¿•å…ç–«ç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šè‡ªé«”å…ç–«é¢¨æš´ï¼Œç—‡ç‹€å¤§äº‚é¬¥ï¼ã€‘", color: "rgba(142, 68, 173, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šå…ç–«ç³»çµ±æ•µæˆ‘ä¸åˆ†ï¼Œé–‹å§‹æ”»æ“Šè‡ªå·±çš„å™¨å®˜ï¼Œå„ç¨®éå…¸å‹ç—‡ç‹€åŒæ™‚å‡ºç¾ï¼Œé€£ä¸»æ²»é†«å¸«éƒ½çœ‰é ­ä¸€çšºã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€è¨ºæ–·è¿·éœ§ã€‘ã€‚ç³»çµ±å¼·åˆ¶ç™¼å‹•å¤§é¢¨å¹ï¼Œæ‰€æœ‰ç©å®¶å°‡æ‰‹ä¸­çš„ 1 å¼µéš¨æ©Ÿé†«å­¸ç‰Œï¼Œå‚³çµ¦ä¸‹ä¸€å®¶ï¼ˆå³é‚Šç©å®¶ï¼‰ã€‚",
              reward: "ä½ ç”¨é¡å›ºé†‡è„ˆè¡ç™‚æ³•å£“ä¸‹é¢¨æš´ï¼ä½ å¯ä»¥æŠŠçµ¦ä¸‹ä¸€å®¶çš„ç‰Œæ‹¿å›ä¾†ï¼Œä¸¦é¡å¤–å¤šæŠ½ 1 å¼µç‰Œã€‚",
              penalty: "ä½ è¢«å„ç¨®å‡é™½æ€§æª¢é©—æ•¸æ“šé¨™äº†ã€‚ä½ å¿…é ˆé¡å¤–å¤šå‚³ 1 å¼µé†«å­¸ç‰Œçµ¦ä¸‹ä¸€å®¶ã€‚",
              qs: [
                  {q:"é‡å°å…¨èº«æ€§ç´…æ–‘æ€§ç‹¼ç˜¡ (SLE) çš„è‡ªé«”æŠ—é«”æª¢æŸ¥ï¼Œä¸‹åˆ—å“ªä¸€ç¨®æŠ—é«”çš„ã€Œç‰¹ç•°æ€§ã€æœ€é«˜ï¼Œä¸”å…¶æ•ˆåƒ¹å¸¸èˆ‡è…è‡Ÿç–¾ç—…çš„æ´»å‹•åº¦å‘ˆæ­£ç›¸é—œï¼Ÿ", opts:["A. ANA","B. Anti-Ro (SSA)","C. Anti-dsDNA"], ans:2},
                  {q:"é¡é¢¨æ¿•æ€§é—œç¯€ç‚ (RA) æ‚£è€…çš„è¡€æ¸…å­¸æª¢æŸ¥ä¸­ï¼Œä¸‹åˆ—å“ªä¸€ç¨®æŠ—é«”å°æ–¼æ—©æœŸè¨ºæ–· RA å…·æœ‰æœ€é«˜çš„ç‰¹ç•°æ€§ï¼Ÿ", opts:["A. é¡é¢¨æ¿•å› å­ (RF)","B. Anti-CCP antibody","C. æŠ—æ ¸æŠ—é«” (ANA)"], ans:1},
                  {q:"ä¸€ä½ç—…æ‚£å› æ€¥æ€§å–®å´ç¬¬ä¸€è¶¾è–è¶¾é—œç¯€ç´…è…«ç†±ç—›å°±é†«ã€‚æŠ½å–é—œç¯€æ¶²åœ¨åå…‰é¡¯å¾®é¡ä¸‹è§€å¯Ÿï¼Œæœ€å…¸å‹æœƒå‘ˆç¾ä¸‹åˆ—ä½•ç¨®ç‰¹å¾µï¼Ÿ", opts:["A. è² å‘é›™æŠ˜å…‰çš„é‡ç‹€çµæ™¶","B. æ­£å‘é›™æŠ˜å…‰çš„è±å½¢çµæ™¶","C. ç„¡é›™æŠ˜å…‰æ€§çš„æ–¹å½¢çµæ™¶"], ans:0},
                  {q:"é‡å°é¡é¢¨æ¿•æ€§é—œç¯€ç‚ (RA) çš„è—¥ç‰©æ²»ç™‚ï¼Œä¸‹åˆ—ä½•è€…è¢«å…¬èªç‚ºæ˜¯ç¬¬ä¸€ç·šä¸”æœ€æ ¸å¿ƒçš„å‚³çµ±åˆæˆç–¾ç—…èª¿ç¯€æŠ—é¢¨æ¿•è—¥ç‰© (csDMARD)ï¼Ÿ", opts:["A. Methotrexate (MTX)","B. Sulfasalazine (SULF)","C. Hydroxychloroquine (HCQ)"], ans:0},
                  {q:"åœ¨é‘‘åˆ¥è¨ºæ–·å¤šç™¼æ€§é—œç¯€ç‚æ™‚ï¼Œã€Œé ç«¯æŒ‡é–“é—œç¯€ (DIP)ã€çš„ä¾µçŠ¯èˆ‡å¦æ˜¯ä¸€å€‹é‡è¦çš„ç·šç´¢ã€‚ä¸‹åˆ—å“ªä¸€ç¨®é—œç¯€ç‚æ¥µå°‘ä¾µçŠ¯é ç«¯æŒ‡é–“é—œç¯€ï¼Ÿ", opts:["A. é¡é¢¨æ¿•æ€§é—œç¯€ç‚ (RA)","B. é€€åŒ–æ€§é—œç¯€ç‚ (OA)","C. ä¹¾ç™¬æ€§é—œç¯€ç‚ (PsA)"], ans:0}
              ]
            },
            { id: "hemato", name: "ğŸ©¸ è¡€æ¶²è…«ç˜¤ç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šåŒ–ç™‚å¾Œ Neutropenia åˆä½µç™¼ç‡’ï¼ã€‘", color: "rgba(44, 62, 80, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šç—…äººç™½è¡€çƒæ‰åˆ°è¶¨è¿‘æ–¼é›¶ï¼Œå®Œå…¨æ²’æœ‰æŠµæŠ—åŠ›ï¼Œä»»ä½•ä¸€é»é¢¨å¹è‰å‹•éƒ½æœƒè¦å‘½ï¼Œæ‰€æœ‰é˜²ç¦¦æ©Ÿåˆ¶å¤±æ•ˆã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€å…ç–«ä½ä¸‹ã€‘ã€‚æœ¬å›åˆå…§ï¼Œå…¨å ´ç©å®¶çš„ã€ŒåŠŸèƒ½ç‰Œã€é­åˆ°å°å°ï¼Œç„¡æ³•ä½¿ç”¨ã€‚",
              reward: "ä½ åŠæ™‚æ–½æ‰“ç™½è¡€çƒç”Ÿé•·æ¿€ç´ ï¼ä½ çš„åŠŸèƒ½ç‰Œå¯ç…§å¸¸ç”Ÿæ•ˆï¼Œä¸¦å¯ç«‹åˆ»æŠ½ 1 å¼µé†«å­¸ç‰Œã€‚",
              penalty: "ç—…äººå¼•ç™¼åš´é‡é»´èŒæ„ŸæŸ“ã€‚ä½ çš„æ‰‹ç‰Œå¿…é ˆå¼·åˆ¶å…¬é–‹ (äº®ç‰Œ) ç›´åˆ°ä¸‹å›åˆçµæŸã€‚",
              qs: [
                  {q:"ä¸€ä½æ‚£è€…å› åš´é‡ç‰™é½¦å‡ºè¡€èˆ‡ç´«æ–‘å°±é†«ï¼Œéª¨é«“æª¢æŸ¥ç™¼ç¾å¤§é‡å‰éª¨é«“ç´°èƒä¸”å«æœ‰ Auer rodsï¼Œé«˜åº¦æ‡·ç–‘ç‚ºæ€¥æ€§å‰éª¨é«“ç´°èƒç™½è¡€ç—… (APL)ã€‚é¦–è¦æ€¥æ•‘è™•ç½®ç‚ºä½•ï¼Ÿ", opts:["A. ç«‹å³çµ¦äºˆ ATRA (å…¨åå¼ç¶­ç”²é…¸)","B. ç­‰å¾…åŸºå› å ±å‘Šç¢ºè¨º t(15;17) å¾Œå†åŒ–ç™‚","C. ç«‹å³é€²è¡Œéª¨é«“ç§»æ¤"], ans:0},
                  {q:"åœ¨æ·‹å·´çµåˆ‡ç‰‡ç—…ç†æª¢æŸ¥ä¸­ï¼Œè‹¥ç™¼ç¾èƒŒæ™¯å……æ»¿ç™¼ç‚ç´°èƒï¼Œä¸”æœ‰å…¸å‹çš„ã€Œè²“é ­é·¹çœ¼ç´°èƒ (Reed-Sternberg cells)ã€ï¼Œæœ€å¯èƒ½çš„è¨ºæ–·ç‚ºä½•ï¼Ÿ", opts:["A. ä½•æ°é‡‘æ°æ·‹å·´ç˜¤","B. ç€°æ¼«æ€§å¤§ B ç´°èƒæ·‹å·´ç˜¤","C. æ¿¾æ³¡æ€§æ·‹å·´ç˜¤"], ans:0},
                  {q:"é‡å°æ™šæœŸè½‰ç§»æ€§å¤§è…¸ç›´è…¸ç™Œæ‚£è€…ï¼Œåœ¨è€ƒæ…®ä½¿ç”¨æŠ— EGFR å–®æ ªæŠ—é«” (å¦‚ Cetuximab) ä½œç‚ºæ¨™é¶æ²»ç™‚å‰ï¼Œå¿…é ˆå…ˆç¢ºèªå“ªä¸€å€‹åŸºå› çš„ç‹€æ…‹ç‚ºé‡ç”Ÿå‹æ‰æœ‰æ•ˆï¼Ÿ", opts:["A. HER2","B. BRAF","C. KRAS"], ans:2},
                  {q:"ç€°æ¼«æ€§è¡€ç®¡å…§å‡è¡€ (DIC) æ˜¯ä¸€ç¨®åš´é‡çš„å‡ºè¡€èˆ‡è¡€æ “ä½µç™¼æ€¥ç—‡ï¼Œä¸‹åˆ—å“ªä¸€çµ„å¯¦é©—å®¤æ•¸æ“šè®ŠåŒ–æœ€ç¬¦åˆ DIC çš„ç‰¹å¾µï¼Ÿ", opts:["A. PT/aPTT å»¶é•·ã€è¡€å°æ¿ä½ä¸‹ã€D-dimer å‡é«˜ã€Fibrinogen ä½ä¸‹","B. PT/aPTT æ­£å¸¸ã€è¡€å°æ¿ä½ä¸‹ã€D-dimer æ­£å¸¸ã€Fibrinogen å‡é«˜","C. PT/aPTT å»¶é•·ã€è¡€å°æ¿æ­£å¸¸ã€D-dimer å‡é«˜ã€Fibrinogen æ­£å¸¸"], ans:0},
                  {q:"ä¸€ä½ç™Œç—‡æ‚£è€…æ¥å—åŒ–ç™‚å¾Œå‡ºç¾ç™¼ç‡’ï¼ŒANC < 500ã€‚åœ¨çµ¦äºˆç¬¬ä¸€ç·šç¶“é©—æ€§æŠ—ç”Ÿç´ æ²»ç™‚æ™‚ï¼Œè—¥ç‰©é »è­œã€Œå¿…é ˆã€èƒ½æ¶µè“‹ä¸‹åˆ—å“ªä¸€ç¨®è‡´å‘½æ€§ç´°èŒï¼Ÿ", opts:["A. ç¶ è†¿æ¡¿èŒ (Pseudomonas aeruginosa)","B. å›°é›£æ¢­ç‹€æ¡¿èŒ","C. çµæ ¸åˆ†ææ¡¿èŒ"], ans:0}
              ]
            },
            { id: "gi", name: "ğŸŸ¨ è‚è†½è…¸èƒƒç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šåŠå¤œé€£ç’° Massive GI Bleedingï¼ã€‘", color: "rgba(243, 156, 18, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šé£Ÿé“éœè„ˆæ›²å¼µå¤§å‡ºè¡€ï¼Œè¡€åº«å­˜è¡€è¢«æŠ½ä¹¾ï¼Œæ€¥è¨ºç‹‚ Call èƒƒé¡å®¤ï¼Œå…¨é™¢è³‡æºé™·å…¥æ¥µåº¦çŸ­ç¼ºã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€è¡€åº«è¦‹åº•ã€‘ã€‚æ‰€æœ‰ç©å®¶å¿…é ˆç«‹åˆ»å¾æ‰‹ä¸ŠçŠ§ç‰²ï¼ˆç›²ä¸Ÿæ£„ï¼‰1 å¼µã€Œä¸»è¨´ (CC)ã€æˆ–ã€Œç—‡ç‹€ (Sx)ã€ç‰Œä¾†æè¡€ (ç„¡å‰‡ç›²ä¸Ÿä»»æ„ç‰Œ)ã€‚",
              reward: "ä½ ä¸€é‡æ‰“æº–äº† Terlipressin ä¸¦æˆåŠŸå¥—ç’°ï¼ä½ ä¸éœ€ä¸Ÿç‰Œï¼Œé‚„å¯ä»¥å¾é†«å­¸æ£„ç‰Œå †é ‚ç«¯å…è²»æ’¿ 1 å¼µå›æ‰‹ç‰Œã€‚",
              penalty: "ä½ æ‰¾ä¸åˆ°å‡ºè¡€é»ã€‚ä½ é™¤äº†è¦çŠ§ç‰²æè¡€ï¼Œé‚„å¿…é ˆå†ç›²ä¸Ÿä¸€å¼µé†«å­¸ç‰Œã€‚",
              qs: [
                  {q:"è‚ç¡¬åŒ–åˆä½µè…¹æ°´ç—…æ‚£ï¼Œè¡€æ¸…-è…¹æ°´ç™½è›‹ç™½æ¢¯åº¦ (SAAG) ç‚º 1.5 g/dLï¼Œä¸”è…¹æ°´ç¸½è›‹ç™½ (AFTP) ç‚º 1.8 g/dLã€‚æœ€å¯èƒ½çš„è…¹æ°´åŸå› ç‚ºä½•ï¼Ÿ", opts:["A. çµæ ¸æ€§è…¹è†œç‚","B. é–€è„ˆé«˜å£“å¼•èµ·çš„è‚ç¡¬åŒ–è…¹æ°´","C. å³å¿ƒè¡°ç«­"], ans:1},
                  {q:"é—œæ–¼æ…¢æ€§ C å‹è‚ç‚çš„æœ€æ–°æ²»ç™‚æŒ‡å¼•ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æœ€æ­£ç¢ºï¼Ÿ", opts:["A. æ²»ç™‚é¦–é¸ä»ç‚ºå¹²æ“¾ç´ åˆä½µé›·å·´å¨æ—","B. æ²»ç™‚æˆåŠŸçš„ç›®æ¨™ç‚ºé”åˆ° SVRï¼Œå³åœè—¥ 12 é€±å¾Œæ¸¬ä¸åˆ°ç—…æ¯’","C. ç¯©æª¢å‡º Anti-HCV é™½æ€§å³ä»£è¡¨æ­£åœ¨æ„ŸæŸ“ï¼Œä¸éœ€æ¸¬ RNA ç›´æ¥çµ¦è—¥"], ans:1},
                  {q:"ä¸€ä½æ€¥æ€§èƒ°è‡Ÿç‚ç—…æ‚£æº–å‚™é€²è¡Œåˆæ­¥è¼¸æ¶²å¾©ç”¦ã€‚æ ¹æ“šæœ€æ–°æ²»ç™‚è§€å¿µï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æœ€æ­£ç¢ºï¼Ÿ", opts:["A. å»ºè­°å¸¸è¦çµ¦äºˆå»£æ•ˆæŠ—ç”Ÿç´ é é˜²æ„ŸæŸ“","B. è¼¸æ¶²é¸æ“‡ä¸Šï¼Œä¹³é…¸æ—æ ¼æ°æ¶² (LR) å„ªæ–¼ç”Ÿç†é£Ÿé¹½æ°´ (NS)","C. çµ•å°ç¦æ­¢æ—©æœŸç”±å£æˆ–è…¸é“é€²é£Ÿï¼Œå¿…é ˆå…¨éœè„ˆç‡Ÿé¤Š (TPN)"], ans:1},
                  {q:"ä¸€ä½ 65 æ­²ç”·æ€§å› ç™¼ç‡’ã€å³ä¸Šè…¹ç—›åŠé»ƒç–¸é€æ€¥è¨ºï¼Œè¡€å£“ 85/50ï¼Œä¸”å‡ºç¾æ„è­˜æ··äº‚ã€‚æ­¤ç—…æ‚£æœ€ç¬¦åˆä½•ç¨®è¨ºæ–·åŠå…¶é¦–é¸è™•ç½®ï¼Ÿ", opts:["A. æ€¥æ€§è†½å›Šç‚ï¼Œç·Šæ€¥è…¹è…”é¡è†½å›Šåˆ‡é™¤è¡“","B. åŒ–è†¿æ€§æ€¥æ€§è†½ç®¡ç‚ï¼Œç·Šæ€¥å…§è¦–é¡é€†è¡Œæ€§è†½èƒ°ç®¡æ”å½± (ERCP) å¼•æµ","C. è†½çŸ³æ€§è…¸é˜»å¡ï¼Œç·Šæ€¥é–‹è…¹å–å‡ºçµçŸ³"], ans:1},
                  {q:"ä¸€ä½ 75 æ­²ç„¡éå»ç—…å²çš„ç”·æ€§ï¼Œçªç™¼å¤§é‡ç„¡ç—›æ€§é®®è¡€ä¾¿é€æ€¥è¨ºã€‚åœ¨è€å¹´äººä¸­ï¼Œé€™ç¨®ç„¡ç—›æ€§ä¸‹æ¶ˆåŒ–é“å¤§å‡ºè¡€æœ€å¸¸è¦‹åŸå› ç‚ºä½•ï¼Ÿ", opts:["A. ç—”ç˜¡å‡ºè¡€","B. å¤§è…¸ç›´è…¸ç™Œå‡ºè¡€","C. å¤§è…¸æ†©å®¤å‡ºè¡€"], ans:2}
              ]
            },
            { id: "meta", name: "ğŸ¬ æ–°é™³ä»£è¬ç§‘", title: "ã€å…¨é™¢å»£æ’­ï¼šæ·±å¤œ DKA èˆ‡ä½è¡€ç³–æ˜è¿·äº¤æ›¿ï¼ã€‘", color: "rgba(255, 105, 180, 0.6)",
              scenario: "è‡¨åºŠæƒ…å¢ƒï¼šè¡€ç³–æ©Ÿç‹‚å«ï¼Œå¤§è…¦å› ç‚ºèƒ½é‡ä¾›æ‡‰ä¸ç©©è€Œç„¡æ³•æ€è€ƒï¼Œå¤§å®¶çš„åº•ç‰Œç›¡éœ²ã€‚",
              global: "å…¨å ´å¼·åˆ¶æ•ˆæœï¼šã€å¤§è…¦èƒ½é‡è€—ç«­ã€‘ã€‚å…¨å ´ç©å®¶å¼·åˆ¶é€²å…¥ã€Œæ˜ç‰Œæ¨¡å¼ã€ï¼Œæ‰€æœ‰äººçš„é†«å­¸æ‰‹ç‰Œå¿…é ˆæ”¤é–‹å‘æ‰€æœ‰äººå±•ç¤ºï¼ŒæŒçºŒä¸€å›åˆã€‚",
              reward: "ä½ åŠæ™‚æ¨äº†å…©æ”¯é«˜æ¿ƒåº¦è‘¡è„ç³–ï¼ä½ çš„å¤§è…¦ç•°å¸¸æ¸…æ™°ï¼Œæ‰‹ç‰Œå›å¾©è¦†è“‹ï¼Œä¸”å¯ä»¥éš¨æ©ŸæŠ½èµ°ä¸€åå°æ‰‹çš„ 1 å¼µé†«å­¸ç‰Œã€‚",
              penalty: "è¡€ç³–æ§åˆ¶å¾¹åº•å¤±æ•—ã€‚ä½ çš„æ‰‹ç‰Œç¶­æŒæ”¤é–‹ï¼Œä¸”ä¸‹å€‹å›åˆä½ è¢«å¼·åˆ¶ã€Œè·³éæŠ½ç‰Œéšæ®µã€ã€‚",
              qs: [
                  {q:"ä¸€ä½ç¬¬äºŒå‹ç³–å°¿ç—…åˆä½µå¿ƒè‡Ÿè¡°ç«­ (HFrEF) çš„ç—…æ‚£ï¼Œä¸‹åˆ—å“ªä¸€ç¨®é™è¡€ç³–è—¥ç‰©ç‚ºç¾è¡ŒæŒ‡å¼•å»ºè­°ä¹‹é¦–é¸ï¼Ÿ", opts:["A. Metformin (é›™èƒé¡)","B. Empagliflozin (SGLT-2 æŠ‘åˆ¶åŠ‘)","C. Pioglitazone (TZD é¡)"], ans:1},
                  {q:"ä¸€ä½ç¬¬ä¸€å‹ç³–å°¿ç—…æ‚£è€…å› åš´é‡ DKA é€æ€¥è¨ºï¼ŒæŠ½è¡€é‰€é›¢å­æ¿ƒåº¦ç‚º 2.8 mEq/Lã€‚é—œæ–¼å…¶ç¬¬ä¸€æ­¥æ€¥æ•‘è™•ç½®ï¼Œä¸‹åˆ—ä½•è€…æœ€æ­£ç¢ºï¼Ÿ", opts:["A. ç«‹å³éœè„ˆè¼¸æ³¨çŸ­æ•ˆèƒ°å³¶ç´ ","B. ç«‹å³çµ¦äºˆç¢³é…¸æ°«é¹½çŸ¯æ­£é…¸è¡€ç—‡","C. çµ•å°ä¸å¯å…ˆæ‰“èƒ°å³¶ç´ ï¼Œå¿…é ˆå…ˆçµ¦äºˆè¼¸æ¶²ä¸¦è£œå……é‰€é›¢å­"], ans:2},
                  {q:"å¹´è¼•å¥³æ€§å‰›è¨ºæ–·è‘›ç‘å¤«èŒ²æ°ç—…ä¸¦æœç”¨ Methimazoleã€‚å…©é€±å¾Œçªç™¼é«˜ç‡’èˆ‡åš´é‡å–‰åš¨ç—›ï¼Œå¿…é ˆç«‹å³åœè—¥ä¸¦æœ€å„ªå…ˆæª¢æŸ¥ä¸‹åˆ—ä½•é …æ•¸å€¼ï¼Ÿ", opts:["A. AST/ALT","B. ç™½è¡€çƒè¨ˆæ•¸ (WBC)","C. Free T4"], ans:1},
                  {q:"é–€è¨ºé‡åˆ°ç–‘ä¼¼åº«æ¬£æ°ç—‡å€™ç¾¤ (Cushing's Syndrome) çš„ç—…æ‚£æ™‚ï¼Œæœ€å¸¸é¦–é¸çš„åˆæ­¥ç¯©æª¢å·¥å…·ç‚ºä½•ï¼Ÿ", opts:["A. æŠ½è¡€æª¢é©—æ—©æ™¨ ACTH","B. éå¤œ 1mg æ¿¾éæ€§æ¯’ç´ æŠ‘åˆ¶è©¦é©— (Overnight 1mg DST)","C. é«˜åŠ‘é‡æ¿¾éæ€§æ¯’ç´ æŠ‘åˆ¶è©¦é©—"], ans:1},
                  {q:"ä¸€ä½é«˜è¡€è„‚ç—…æ‚£åŒæ™‚æœç”¨ Statin é¡èˆ‡ Fibrate é¡è—¥ç‰©ã€‚æ­¤è—¥ç‰©çµ„åˆæœ€å®¹æ˜“å¤§å¹…å¢åŠ ä¸‹åˆ—å“ªä¸€ç¨®åš´é‡å‰¯ä½œç”¨çš„é¢¨éšªï¼Ÿ", opts:["A. çŒ›çˆ†æ€§è‚ç‚","B. æ€¥æ€§èƒ°è‡Ÿç‚","C. æ©«ç´‹è‚Œæº¶è§£ç—‡ (Rhabdomyolysis)"], ans:2}
              ]
            }
        ];

        let globalEffects = { noTx: 0, noAction: 0, revealHands: 0, handLimit: 0 };
        let playerImmune = { noTx: false, skipOrder: false, noAction: false, revealHands: false, handLimit: false, skipDraw: false };

        let players = [
            { id: 0, name: "ä½ ", isHuman: true, hand: [], actionHand: [], table: [], maxLimit: 7, hasDNR: false, isRevealed: false, skipTurn: false },
            { id: 1, name: "æ°¸å¼·", isHuman: false, hand: [], actionHand: [], table: [], maxLimit: 7, hasDNR: false, isRevealed: false, skipOrder: false, skipDraw: false, skipTurn: false },
            { id: 2, name: "åŠ‰è‹±", isHuman: false, hand: [], actionHand: [], table: [], maxLimit: 7, hasDNR: false, isRevealed: false, skipOrder: false, skipDraw: false, skipTurn: false },
            // ğŸŒŸ å°‡éµæŸ±æ”¹ç‚ºå¸¸è²´
            { id: 3, name: "å¸¸è²´", isHuman: false, hand: [], actionHand: [], table: [], maxLimit: 7, hasDNR: false, isRevealed: false, skipOrder: false, skipDraw: false, skipTurn: false }
        ];

        let currentPlayerIndex = 0;
        let medicalDeck = [], actionDeck = [];
        let discardPile = [], actionDiscardPile = []; 
        let hasDrawnThisTurn = false;
        let hasPlayedActionThisTurn = false; 
        let isAnimating = false; 
        let pendingActionIdx = -1; 
        let draggedCardIndex = null;

        let firstPlayerIndex = 0;
        let completedRounds = 0;
        let nextEventRound = 2; 

        // ğŸŒŸ æ–°å¢ï¼šäº‹ä»¶å€’æ•¸è¨ˆæ™‚ç›¸é—œè®Šæ•¸
        let quizTimer;
        let quizTimeLeft = 30;

        function buildDecks() {
            medicalDeck = []; actionDeck = [];
            medicalDeckBlueprint.forEach(c => { 
                let count = c.count || 5; 
                for(let i=0; i<count; i++) medicalDeck.push(Object.assign({}, c)); 
            });
            
            actionDeckBlueprint.forEach(c => { 
                let count = c.count || 3; 
                for(let i=0; i<count; i++) actionDeck.push(Object.assign({}, c)); 
            });
            
            medicalDeck.sort(() => Math.random() - 0.5); 
            actionDeck.sort(() => Math.random() - 0.5);
        }

        function drawFromDeck(type) {
            let deck = type === 'medical' ? medicalDeck : actionDeck;
            let discard = type === 'medical' ? discardPile : actionDiscardPile;
            if (deck.length === 0) {
                if (discard.length === 0) return null;
                showToast(type === 'medical' ? "ğŸ”„ é†«å­¸ç‰Œåº«å·²ç©ºï¼ç—…æ­·å®¤å¤§æ­¸æª”ï¼" : "ğŸ”„ åŠŸèƒ½ç‰Œåº«å·²ç©ºï¼å€¼ç­æ©Ÿå¤§äº¤ç­ï¼");
                while(discard.length > 0) deck.push(discard.pop());
                deck.sort(() => Math.random() - 0.5);
            }
            let card = deck.pop();
            if(card) card.isNew = true; 
            return card;
        }

        function addToDiscard(card, discarderName) {
            if(!card) return;
            card.discarder = discarderName || "ç³»çµ±";
            card.roundDiscarded = completedRounds; 
            card.isSelected = false;
            discardPile.push(card);
        }

        async function startGame() {
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("game-wrapper").style.display = "flex"; 
            
            buildDecks();
            
            for (let p of players) {
                for(let i=0; i<7; i++) p.hand.push(Object.assign({isSelected: false}, drawFromDeck('medical')));
                for(let i=0; i<3; i++) p.actionHand.push(drawFromDeck('action'));
                
                let hasCC = p.hand.some(c => c.type === "CC" || c.type === "Wildcard");
                if (!hasCC) {
                    while(p.hand.length > 0) medicalDeck.push(p.hand.pop());
                    medicalDeck.sort(() => Math.random() - 0.5);
                    for(let i=0; i<7; i++) p.hand.push(Object.assign({isSelected: false}, drawFromDeck('medical')));
                }
            }

            currentPlayerIndex = Math.floor(Math.random() * 4);
            firstPlayerIndex = currentPlayerIndex;
            completedRounds = 0;
            nextEventRound = 2;

            // ğŸŒŸ æ–°å¢ï¼š2ç§’èµ·å§‹å®£å‘Šå‹•ç•«
            let overlay = document.getElementById("start-turn-overlay");
            let msgEl = document.getElementById("start-turn-msg");
            msgEl.innerHTML = `éŠæˆ²é–‹å§‹ï¼<br><span style="color:white; font-size:40px;">ç¬¬ä¸€å›åˆç”±ã€${players[currentPlayerIndex].name}ã€‘å…ˆæ‰‹</span>`;
            overlay.style.display = "flex";
            await sleep(2000);
            overlay.style.display = "none";

            startTurn();
        }

        // ğŸŒŸ æ–°å¢ï¼šå€’æ•¸è¨ˆæ™‚èˆ‡å¼·åˆ¶ä½œç­”å¤±æ•—æ©Ÿåˆ¶
        function startQuizTimer(eventId, penaltyText) {
            quizTimeLeft = 30;
            let bar = document.getElementById("quiz-timer-bar");
            bar.style.width = "100%";
            
            clearInterval(quizTimer);
            quizTimer = setInterval(() => {
                quizTimeLeft--;
                bar.style.width = (quizTimeLeft / 30 * 100) + "%";
                
                if (quizTimeLeft <= 0) {
                    clearInterval(quizTimer);
                    // è¶…æ™‚è¦–ç‚ºé¸éŒ¯ (å‚³å…¥ä¸€å€‹ä¸å¯èƒ½æ­£ç¢ºçš„ç´¢å¼• -1)
                    submitQuizAnswer(eventId, -1, 0, "", penaltyText);
                }
            }, 1000);
        }

        async function triggerRandomEvent() {
            return new Promise(async resolve => {
                isAnimating = true;
                let ev = eventDB[Math.floor(Math.random() * eventDB.length)];
                
                let overlay = document.getElementById("flash-overlay");
                overlay.style.setProperty('--flash-color', ev.color);
                overlay.classList.add("flashing");
                showToast(ev.title);
                await sleep(1500);
                overlay.classList.remove("flashing");

                players.forEach(p => {
                    if (!p.isHuman) {
                        p.passedEvent = (Math.random() <= 0.60);
                    }
                });
                
                let qData = ev.qs[Math.floor(Math.random() * ev.qs.length)];
                document.getElementById("quiz-dept-title").innerText = `${ev.name} ${ev.title}`;
                document.getElementById("quiz-scenario").innerText = ev.scenario;
                document.getElementById("quiz-global").innerText = ev.global;
                document.getElementById("quiz-question-text").innerText = qData.q;
                
                let optsContainer = document.getElementById("quiz-options-container");
                optsContainer.innerHTML = qData.opts.map((opt, i) => 
                    `<button class="quiz-option" onclick="submitQuizAnswer('${ev.id}', ${i}, ${qData.ans}, '${ev.reward}', '${ev.penalty}')">${opt}</button>`
                ).join("");

                window.currentEventResolve = resolve;
                document.getElementById("quiz-modal").style.display = "block";
                
                // å•Ÿå‹• 30 ç§’å€’æ•¸
                startQuizTimer(ev.id, ev.penalty);
            });
        }

        async function submitQuizAnswer(eventId, selected, correctAns, rewardText, penaltyText) {
            clearInterval(quizTimer); // åœæ­¢è¨ˆæ™‚å™¨
            document.getElementById("quiz-modal").style.display = "none";
            
            let isCorrect = (selected === correctAns);
            players[0].passedEvent = isCorrect;

            if (isCorrect) {
                await playCinematicAsync({name:"ğŸ¯ ç­”å°äº†ï¼", desc:""}, "åœ‹è€ƒå¤§å¸«", rewardText);
            } else {
                if (selected === -1) await playCinematicAsync({name:"â³ è¶…æ™‚æœªç­”ï¼", desc:""}, "çŒ¶è±«ä¸æ±º", penaltyText);
                else await playCinematicAsync({name:"ğŸ’€ ç­”éŒ¯äº†ï¼", desc:""}, "é†«ç™‚ç–å¤±", penaltyText);
            }

            Object.keys(playerImmune).forEach(k => playerImmune[k] = false);
            players.forEach(p => { if(!p.isHuman) { p.immuneNoTx = false; p.immuneNoAction = false; p.immuneRevealHands = false; p.immuneHandLimit = false; }});

            let nextRnd = completedRounds + 1;
            if (eventId === "chest") globalEffects.noTx = nextRnd;
            if (eventId === "id" || eventId === "hemato") globalEffects.noAction = nextRnd;
            if (eventId === "meta") globalEffects.revealHands = nextRnd;
            if (eventId === "nephro") globalEffects.handLimit = nextRnd;

            for (let i = 0; i < players.length; i++) {
                let p = players[i];
                let passed = p.passedEvent;

                if (i !== 0) {
                    if (passed) showToast(`ğŸ¤– ${p.name} é †åˆ©è§£æ±ºäº†å±æ©Ÿï¼(ç­”å°)`);
                    else showToast(`âš ï¸ ${p.name} ç™¼ç”Ÿé†«ç™‚ç–å¤±ï¼(ç­”éŒ¯)`);
                }

                switch (eventId) {
                    case "chest":
                        if (passed) {
                            if(i===0) playerImmune.noTx = true; else p.immuneNoTx = true;
                            let validIdx = discardPile.findLastIndex(c => c.type==="Tx" || c.type==="Dx");
                            if (validIdx !== -1) p.hand.push(discardPile.splice(validIdx, 1)[0]);
                            else { let n = drawFromDeck('medical'); if(n) p.hand.push(n); }
                        } else {
                            let tIdx = p.hand.findIndex(c => c.type==="Tx");
                            if (tIdx !== -1) addToDiscard(p.hand.splice(tIdx, 1)[0], p.name);
                            else if (p.hand.length > 0) addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        }
                        break;
                    case "cv":
                        if (p.hand.length > 0) addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        let c1 = drawFromDeck('medical'); if(c1) p.hand.push(Object.assign({isSelected:false, isNew:true}, c1));

                        if (passed) {
                            let n = drawFromDeck('medical'); if(n) p.hand.push(n);
                        } else {
                            if(i===0) playerImmune.skipOrder = true; else p.skipOrder = true;
                        }
                        break;
                    case "nephro":
                        if (passed) {
                            if(i===0) playerImmune.handLimit = true; else p.immuneHandLimit = true;
                            let act = drawFromDeck('action'); if(act) p.actionHand.push(act);
                        } else {
                            if (p.hand.length > 0) addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        }
                        let limit = ((i===0 && playerImmune.handLimit) || (i!==0 && p.immuneHandLimit)) ? p.maxLimit : 5;
                        while (p.hand.length > limit) {
                            addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        }
                        break;
                    case "id":
                        if (passed) {
                            if(i===0) playerImmune.noAction = true; else p.immuneNoAction = true;
                        } else {
                            if (p.actionHand.length > 0) actionDiscardPile.push(p.actionHand.splice(Math.floor(Math.random()*p.actionHand.length), 1)[0]);
                            else if (p.hand.length > 0) addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        }
                        break;
                    case "hemato":
                        if (passed) {
                            if(i===0) playerImmune.noAction = true; else p.immuneNoAction = true;
                            let n = drawFromDeck('medical'); if(n) p.hand.push(n); 
                        } else {
                            p.isRevealed = true;
                        }
                        break;
                    case "gi":
                        if (passed) {
                            let top = discardPile.pop(); if(top) p.hand.push(top);
                        } else {
                            let ccIdx = p.hand.findIndex(c => c.type === "CC" || c.type === "Sx");
                            if (ccIdx !== -1) addToDiscard(p.hand.splice(ccIdx, 1)[0], p.name);
                            else if(p.hand.length>0) addToDiscard(p.hand.splice(0, 1)[0], p.name);
                            
                            if(p.hand.length>0) addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        }
                        break;
                    case "meta":
                        if (passed) {
                            if(i===0) playerImmune.revealHands = true; else p.immuneRevealHands = true;
                            p.isRevealed = false;
                            let targets = players.filter(t => t.id !== p.id && t.hand.length > 0);
                            if (targets.length > 0) {
                                let target = targets[Math.floor(Math.random() * targets.length)];
                                p.hand.push(target.hand.splice(Math.floor(Math.random()*target.hand.length), 1)[0]);
                            }
                        } else {
                            if(i===0) playerImmune.skipDraw = true; else p.skipDraw = true;
                        }
                        break;
                }
            }

            if (eventId === "rheuma") {
                let passArr = [];
                players.forEach(p => {
                    let passCount = p.passedEvent ? 1 : 2;
                    let gave = [];
                    for(let k=0; k<passCount; k++) {
                        if(p.hand.length > 0) gave.push(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0]);
                    }
                    passArr.push(gave);
                });
                for(let i=0; i<players.length; i++){
                    let leftIdx = (i + 3) % 4; 
                    passArr[leftIdx].forEach(c => players[i].hand.push(c));
                    if(players[i].passedEvent) {
                        let n = drawFromDeck('medical'); if(n) players[i].hand.push(n);
                    }
                }
            }

            renderAll();
            isAnimating = false;
            if (window.currentEventResolve) window.currentEventResolve();
        }

        async function startTurn() {
            hasDrawnThisTurn = false;
            hasPlayedActionThisTurn = false; 
            
            let curP = players[currentPlayerIndex];
            if (curP.skipTurn) {
                curP.skipTurn = false;
                showToast(`ğŸš« å—åˆ°æ ¸å¿ƒèª²ç¨‹å½±éŸ¿ï¼Œã€${curP.name}ã€‘çš„å›åˆè¢«å¼·åˆ¶è·³éäº†ï¼`);
                document.getElementById("turn-announcement").innerHTML = `ğŸ”„ ç¬¬ ${completedRounds + 1} è¼ª | ğŸš« ã€${curP.name}ã€‘è¢«è·³éï¼`;
                renderAll();
                await sleep(1500);
                await passToNextPlayer();
                return;
            }

            if (globalEffects.noTx <= completedRounds) globalEffects.noTx = 0;
            if (globalEffects.noAction <= completedRounds) globalEffects.noAction = 0;
            if (globalEffects.revealHands <= completedRounds) globalEffects.revealHands = 0;
            if (globalEffects.handLimit <= completedRounds) globalEffects.handLimit = 0;

            if (completedRounds > 0 && completedRounds >= nextEventRound && currentPlayerIndex === firstPlayerIndex) {
                if (!window.eventTriggeredThisRound) {
                    window.eventTriggeredThisRound = true;
                    nextEventRound = completedRounds + (Math.floor(Math.random() * 2) + 3); 
                    await triggerRandomEvent();
                }
            }
            if (currentPlayerIndex === firstPlayerIndex && completedRounds !== nextEventRound) {
                window.eventTriggeredThisRound = false;
            }

            if (globalEffects.revealHands > 0) {
                players.forEach((p, i) => {
                    let immune = (i === 0) ? playerImmune.revealHands : p.immuneRevealHands;
                    if (!immune) p.isRevealed = true;
                });
            } else {
                players.forEach(p => p.isRevealed = false);
            }

            let roundsToNext = nextEventRound - completedRounds;
            if(roundsToNext < 0) roundsToNext = 0;
            document.getElementById("event-countdown").innerText = roundsToNext;
            if (roundsToNext === 1) document.getElementById("event-timer-box").style.borderColor = "#e74c3c";
            else document.getElementById("event-timer-box").style.borderColor = "#f1c40f";
            
            document.getElementById("turn-announcement").innerHTML = `ğŸ”„ ç¬¬ ${completedRounds + 1} è¼ª | ğŸ“¢ ç¾åœ¨æ˜¯ã€${curP.name}ã€‘çš„å›åˆ`;
            
            let drawBtn = document.getElementById("draw-btn");
            if (curP.isHuman) {
                drawBtn.classList.remove("disabled"); drawBtn.classList.add("player-turn-highlight");
            } else {
                drawBtn.classList.add("disabled"); drawBtn.classList.remove("player-turn-highlight");
            }
            renderAll();

            if (!curP.isHuman) setTimeout(() => botTurn(curP), 1500);
        }

        async function passToNextPlayer() {
            if (checkWin()) return;
            currentPlayerIndex = (currentPlayerIndex + 1) % 4;

            if (currentPlayerIndex === firstPlayerIndex) {
                completedRounds++;
                if (completedRounds > 0 && completedRounds % 3 === 0) {
                    let dummyCard = { name: "ç‰©è³‡ç©ºæŠ•", desc: "æ¯3è¼ªå®šæœŸé…çµ¦ï¼Œå…¨å“¡ç²å¾— 1 å¼µåŠŸèƒ½ç‰Œï¼", type: "Action", img: "" };
                    await playCinematicAsync(dummyCard, "ğŸ¥ é†«é™¢å»£æ’­ç³»çµ±", "å…¨å“¡é…ç™¼è£œçµ¦ï¼");

                    players.forEach(p => {
                        if (p.actionHand.length < 3) {
                            let act = drawFromDeck('action');
                            if (act) { act.isNew = true; p.actionHand.push(act); }
                        }
                    });
                    renderAll();
                    await sleep(1000);
                }
            }
            startTurn();
        }

        async function endTurn() {
            if (isAnimating) return;
            if (currentPlayerIndex !== 0) return showToast("âš ï¸ ç¾åœ¨ä¸æ˜¯ä½ çš„å›åˆï¼");
            if (!hasDrawnThisTurn) return showToast("âš ï¸ é‚„æ²’æŸ¥æˆ¿ï¼è«‹å…ˆæŠ½é†«å­¸ç‰Œã€‚");
            
            let pLimit = (globalEffects.handLimit > 0 && !playerImmune.handLimit) ? 5 : players[0].maxLimit;
            if (players[0].hand.length > pLimit) return showToast(`âš ï¸ æ‰‹ç‰Œè¶…éä¸Šé™(${pLimit}å¼µ)ï¼è«‹å…ˆä¸Ÿæ£„å¤šé¤˜æ‰‹ç‰Œã€‚`);
            
            playerImmune.skipOrder = false;
            playerImmune.skipDraw = false;

            showToast("â¡ï¸ ä½ çš„å›åˆçµæŸï¼");
            await passToNextPlayer();
        }

        function dragStart(e, index) { draggedCardIndex = index; e.target.classList.add("dragging"); }
        function dragOver(e) { e.preventDefault(); }
        function drop(e, dropIndex) {
            e.preventDefault();
            let draggedEl = document.querySelector(".dragging");
            if(draggedEl) draggedEl.classList.remove("dragging");
            if (draggedCardIndex === null || draggedCardIndex === dropIndex) return;
            let pHand = players[0].hand;
            let card = pHand.splice(draggedCardIndex, 1)[0];
            pHand.splice(dropIndex, 0, card);
            renderAll();
        }

        function showRevealedHand(botId) {
            let bot = players[botId];
            if(!bot.isRevealed) return;
            document.getElementById("reveal-target-name").innerText = bot.name;
            let container = document.getElementById("reveal-hand-container");
            
            container.innerHTML = bot.hand.map(c => {
                let imgHtml = generateImgHtml(c);
                return `
                <div class="card type-${c.type}" style="width: 140px; min-height: 180px; padding: 15px; cursor: default; transform: none; box-shadow: 2px 2px 10px rgba(0,0,0,0.3); margin: 5px;">
                    ${imgHtml}
                    <div class="card-title" style="font-size:18px; margin-bottom: 8px;">${c.name}</div>
                    <div class="card-type-badge" style="font-size:14px; padding: 4px 8px;">${typeMap[c.type]}</div>
                </div>
            `}).join("");
            
            document.getElementById("reveal-modal").style.display = "block";
        }

        function showDiscardModal() {
            let list = document.getElementById("discard-list");
            list.innerHTML = discardPile.length === 0 ? "<p style='text-align:center;'>ç›®å‰ç©ºç©ºçš„</p>" : discardPile.map(c => `
                <div style="margin-bottom:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div><span class="bot-case-card type-${c.type}">${typeMap[c.type]}</span> <strong>${c.name}</strong></div>
                    <div style="font-size:12px; color:#7f8c8d;">${c.discarder} ä¸Ÿæ£„ (ç¬¬${c.roundDiscarded}è¼ª)</div>
                </div>`).reverse().join("");
            document.getElementById("discard-modal").style.display = "block";
        }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function toggleCardSelection(index) { 
            if(isAnimating || currentPlayerIndex !== 0) return; 
            players[0].hand[index].isSelected = !players[0].hand[index].isSelected; 
            renderAll(); 
        }
        function showGuideModal() { document.getElementById("guide-modal").style.display = "block"; }

        function checkWin() {
            for (let p of players) {
                if (p.table.length >= 2) {
                    document.getElementById("victory-title").innerText = p.isHuman ? "ğŸ‰ æ­å–œå‹åˆ©ï¼" : "ğŸ˜­ éŠæˆ²çµæŸï¼";
                    document.getElementById("victory-desc").innerText = `${p.name} ç‡å…ˆæ¹Šæ»¿ 2 åºŠç—…äººï¼Œæ´—æ‰‹ä¸‹ç­äº†ï¼`;
                    document.getElementById("game-over-screen").style.display = "flex";
                    // ğŸŒŸ å¦‚æœæ˜¯ç©å®¶ç²å‹ï¼Œé¡¯ç¤ºåœ‹è€ƒè¶¨å‹¢åˆ†ææŒ‰éˆ•
                    if (p.isHuman) {
                        document.getElementById("study-link").style.display = "inline-block";
                    } else {
                        document.getElementById("study-link").style.display = "none";
                    }
                    return true;
                }
            }
            return false;
        }

        function validateCase(selectedCards, isDNRActive, isPlayer=false) {
            let wildcards = selectedCards.filter(c => c.type === "Wildcard").length;
            let normals = selectedCards.filter(c => c.type !== "Wildcard");
            
            if (selectedCards.length !== 3 && selectedCards.length !== 4) {
                if (isDNRActive) return { valid: false, msg: "é€€ä»¶ï¼è«‹é¸å– 4 å¼µç‰Œï¼ˆå«æ²»ç™‚ï¼‰æˆ– 3 å¼µç‰Œï¼ˆDNRå…æ²»ï¼‰ï¼" };
                return { valid: false, msg: "é€€ä»¶ï¼å¿…é ˆå‰›å¥½é¸å– 4 å¼µç‰Œï¼ˆä¸»è¨´+ç—‡ç‹€+è¨ºæ–·+æ²»ç™‚ï¼‰ï¼" };
            }

            let isUsingDNR = (selectedCards.length === 3);

            if (isUsingDNR) {
                if (!isDNRActive) return { valid: false, msg: "é€€ä»¶ï¼ç›®å‰ç„¡ã€DNRã€‘ç‹€æ…‹ï¼Œå¿…é ˆé¸å– 4 å¼µç‰Œï¼" };
                if (wildcards > 0) return { valid: false, msg: "é€€ä»¶ï¼ä½¿ç”¨ã€DNRã€‘å…æ²»ç™‚æ”¶æ²»æ™‚ï¼Œä¸å¯ä½¿ç”¨ã€æœƒè¨ºå–®ã€‘ï¼" };
            } else {
                if (wildcards > 1) return { valid: false, msg: "é€€ä»¶ï¼ä¸€åºŠç—…äººæœ€å¤šåªèƒ½ä½¿ç”¨ 1 å¼µã€æœƒè¨ºå–®ã€‘ï¼" };
                
                if (globalEffects.noTx > 0 && (!isPlayer || !playerImmune.noTx)) {
                    let hasTx = selectedCards.some(c => c.type === "Tx");
                    if (hasTx) return { valid: false, msg: "é€€ä»¶ï¼å…¨é™¢å‘¼å¸è¡°ç«­æ¶æ•‘ä¸­ï¼Œç¦æ­¢æ‰“å‡ºä»»ä½•æ²»ç™‚ç‰Œ(Tx)ï¼" };
                }
            }

            for (let recipe of validRecipes) {
                let reqTypes = ["cc", "sx", "dx"]; 
                if (!isUsingDNR) reqTypes.push("tx");

                let tWilds = wildcards, tRem = [...normals], isMatch = true;
                for (let req of reqTypes) {
                    let validOpts = recipe[req];
                    let fIdx = tRem.findIndex(c => validOpts.includes(c.name));
                    if (fIdx !== -1) tRem.splice(fIdx, 1);
                    else if (tWilds > 0) tWilds--;
                    else { isMatch = false; break; }
                }
                if (isMatch && tRem.length === 0) return { valid: true, recipeName: recipe.name, usedDNR: isUsingDNR };
            }
            return { valid: false, msg: "å¡ç‰Œçµ„åˆä¸ç¬¦åˆä»»ä½•è‡¨åºŠæŒ‡å¼•ï¼" };
        }

        function drawMedicalCard() {
            if (isAnimating || currentPlayerIndex !== 0) return;
            if (hasDrawnThisTurn) return showToast("âš ï¸ æ‚¨é€™å›åˆå·²ç¶“æŠ½éç‰Œå›‰ï¼");
            
            if (playerImmune.skipDraw) {
                showToast("âŒ å—ä½è¡€ç³–æ˜è¿·å½±éŸ¿ï¼Œä½ æœ¬å›åˆç„¡æ³•æŠ½ç‰Œï¼");
                hasDrawnThisTurn = true; 
                renderAll();
                return;
            }

            let newCard = drawFromDeck('medical');
            if(newCard) {
                players[0].hand.push(Object.assign({isSelected: false}, newCard));
                hasDrawnThisTurn = true; 
                renderAll();
            }
        }

        function admitPatient() {
            if (isAnimating || currentPlayerIndex !== 0) return;
            if (playerImmune.skipOrder) return showToast("âŒ å—è² é¢ç‹€æ…‹å½±éŸ¿ï¼Œä½ æœ¬å›åˆç„¡æ³•æ”¶æ²»ï¼");

            let p = players[0];
            let selectedIdxs = [];
            p.hand.forEach((c, i) => { if(c.isSelected) selectedIdxs.push(i); });
            
            let selected = selectedIdxs.map(i => p.hand[i]);
            let valResult = validateCase(selected, p.hasDNR, true);

            if (valResult.valid) {
                isAnimating = true;
                selectedIdxs.forEach(idx => {
                    let el = document.getElementById(`my-card-${idx}`);
                    if(el) el.classList.add("animate-admit");
                });

                setTimeout(() => {
                    showToast(`ğŸŠ æ”¶æ²»æˆåŠŸï¼è¨ºæ–·ç‚ºï¼šã€${valResult.recipeName}ã€‘`);
                    selected.forEach(c => c.recipeName = valResult.recipeName); 
                    p.table.push(selected);
                    p.hand = p.hand.filter(c => !c.isSelected);
                    
                    if (valResult.usedDNR) p.hasDNR = false; 
                    
                    if (p.actionHand.length < 3) {
                        let newAct = drawFromDeck('action');
                        if(newAct) { p.actionHand.push(newAct); showToast("ğŸ æˆåŠŸæ”¶æ²»ï¼ç²å¾— 1 å¼µåŠŸèƒ½ç‰Œçå‹µï¼"); }
                    } else showToast("âš ï¸ ä½ çš„åŠŸèƒ½ç‰Œå·²é” 3 å¼µä¸Šé™ï¼Œç„¡æ³•é ˜å–çå‹µï¼");
                    
                    isAnimating = false;
                    renderAll();
                    checkWin(); 
                }, 400); 
            } else { showToast("âŒ " + valResult.msg); }
        }

        function discardCard() {
            if (isAnimating || currentPlayerIndex !== 0) return;
            let p = players[0];
            let pLimit = (globalEffects.handLimit > 0 && !playerImmune.handLimit) ? 5 : p.maxLimit;

            if (p.hand.length <= pLimit) return showToast(`âš ï¸ æ‰‹ç‰Œæœªè¶…éä¸Šé™ (${pLimit} å¼µ)ï¼Œç›®å‰ç„¡æ³•æ£„ç‰Œï¼`);

            let selectedIdxs = [];
            p.hand.forEach((c, i) => { if(c.isSelected) selectedIdxs.push(i); });
            if (selectedIdxs.length !== 1) return showToast("âš ï¸ è«‹é¸å–ã€å‰›å¥½ 1 å¼µã€‘ä¸éœ€è¦çš„ç‰Œä¸Ÿæ£„ã€‚");
            
            isAnimating = true;
            let idx = selectedIdxs[0];
            let el = document.getElementById(`my-card-${idx}`);
            if(el) el.classList.add("animate-exit");

            setTimeout(() => {
                let cardToDiscard = p.hand.splice(idx, 1)[0];
                addToDiscard(cardToDiscard, p.name);
                showToast(`ğŸ—‘ï¸ ä½ ä¸Ÿæ£„äº†ã€${cardToDiscard.name}ã€‘ã€‚`);
                isAnimating = false;
                renderAll();
            }, 300);
        }

        async function botTurn(bot) {
            if (bot.skipDraw) {
                bot.skipDraw = false;
            } else {
                let newCard = drawFromDeck('medical');
                if(newCard) bot.hand.push(newCard);
            }
            renderAll();
            await sleep(1500);
            
            let canAct = true;
            if (bot.skipOrder || (globalEffects.noAction > 0 && !bot.immuneNoAction)) canAct = false;

            if (canAct) {
                for(let i=bot.actionHand.length-1; i>=0; i--) {
                    if(hasPlayedActionThisTurn) break;
                    let card = bot.actionHand[i];
                    
                    if (card.cat === "buff" && Math.random() > 0.4) {
                        actionDiscardPile.push(bot.actionHand.splice(i, 1)[0]);
                        hasPlayedActionThisTurn = true;
                        await playCinematicAsync(card, `ğŸ¤– ${bot.name}`, `ç™¼å‹•ã€${card.name}ã€‘ï¼`);
                        
                        if (card.effectId === "bg") {
                            let validTargets = players.filter(p => p.id !== bot.id && p.actionHand.length > bot.actionHand.length);
                            let targetId = validTargets.length > 0 ? validTargets[Math.floor(Math.random() * validTargets.length)].id : 0;
                            await executeCardEffect(card, bot.id, targetId);
                        } else if (card.effectId === "duty") {
                            await executeCardEffect(card, bot.id, bot.id);
                        } else {
                            await executeCardEffect(card, bot.id, bot.id);
                        }
                        await sleep(1200); 
                    } 
                    else if (card.cat === "global" && Math.random() > 0.6) {
                        actionDiscardPile.push(bot.actionHand.splice(i, 1)[0]);
                        hasPlayedActionThisTurn = true;
                        await playCinematicAsync(card, `ğŸ¤– ${bot.name}`, `ç™¼å‹•å…¨åŸŸé­”æ³•ï¼`);
                        await executeCardEffect(card, bot.id, bot.id);
                        await sleep(1200);
                    }
                    else if (card.cat === "attack" && Math.random() > 0.5) {
                        let validTargets = players.filter(p => p.id !== bot.id);
                        if (card.effectId === "audit") validTargets = validTargets.filter(p => p.table.length > 0);
                        if (card.effectId === "tryhard" || card.effectId === "copy") validTargets = validTargets.filter(p => p.hand.length > 0);
                        
                        if(validTargets.length === 0) continue;
                        
                        let target = validTargets[Math.floor(Math.random() * validTargets.length)];
                        actionDiscardPile.push(bot.actionHand.splice(i, 1)[0]);
                        hasPlayedActionThisTurn = true;
                        
                        await playCinematicAsync(card, `ğŸ¤– ${bot.name}`, `å°ã€${target.name}ã€‘ç™¼å‹•æ”»æ“Šï¼`);
                        await processAttack(bot.id, target.id, card, async function(finalTargetId) { 
                            await executeCardEffect(card, bot.id, finalTargetId); 
                        });
                        await sleep(1200);
                    }
                }

                let bestRecipe = null, bestCardsToPlay = [];
                let isDNRAdmit = false;

                if (bot.hasDNR) {
                    for (let recipe of validRecipes) {
                        let reqTypes = ["cc", "sx", "dx"];
                        let usedIdxs = [], isMatch = true;
                        for (let req of reqTypes) {
                            let vOpts = recipe[req];
                            let fIdx = bot.hand.findIndex((c, i) => !usedIdxs.includes(i) && c.type !== "Wildcard" && vOpts.includes(c.name));
                            if (fIdx !== -1) usedIdxs.push(fIdx);
                            else { isMatch = false; break; }
                        }
                        if (isMatch) { bestRecipe = recipe.name; bestCardsToPlay = usedIdxs.map(idx => bot.hand[idx]); isDNRAdmit = true; break; }
                    }
                }

                if (!bestRecipe) {
                    for (let recipe of validRecipes) {
                        let reqTypes = ["cc", "sx", "dx", "tx"];
                        if (globalEffects.noTx > 0 && !bot.immuneNoTx) continue; 

                        let wIdxs = bot.hand.map((c, idx) => c.type === "Wildcard" ? idx : -1).filter(i => i !== -1).slice(0, 1);
                        let usedIdxs = [], isMatch = true;

                        for (let req of reqTypes) {
                            let vOpts = recipe[req];
                            let fIdx = bot.hand.findIndex((c, i) => !usedIdxs.includes(i) && c.type !== "Wildcard" && vOpts.includes(c.name));
                            if (fIdx !== -1) usedIdxs.push(fIdx); 
                            else if (wIdxs.length > 0) usedIdxs.push(wIdxs.pop());
                            else { isMatch = false; break; }
                        }
                        if (isMatch) { bestRecipe = recipe.name; bestCardsToPlay = usedIdxs.map(idx => bot.hand[idx]); isDNRAdmit = false; break; }
                    }
                }

                if (bestRecipe) {
                    let idxsToRem = bestCardsToPlay.map(c => bot.hand.indexOf(c)).sort((a,b) => b-a);
                    let caseToAdmit = [];
                    for (let idx of idxsToRem) caseToAdmit.push(bot.hand.splice(idx, 1)[0]);
                    
                    caseToAdmit.recipeName = bestRecipe; bot.table.push(caseToAdmit);
                    showToast(`ğŸ“¢ ${bot.name} å®Œç¾æ”¶æ²»äº†ä¸€åºŠã€${bestRecipe}ã€‘ï¼`);
                    
                    if(isDNRAdmit) bot.hasDNR = false; 
                    if(bot.actionHand.length < 3) { let act = drawFromDeck('action'); if(act) bot.actionHand.push(act); }
                    renderAll();
                    await sleep(1500); 
                }
            }

            bot.skipOrder = false;

            let bLimit = (globalEffects.handLimit > 0 && !bot.immuneHandLimit) ? 5 : bot.maxLimit;
            while(bot.hand.length > bLimit) {
                let dropCard = bot.hand.splice(Math.floor(Math.random() * bot.hand.length), 1)[0];
                addToDiscard(dropCard, bot.name);
            }
            
            await sleep(800); 
            await passToNextPlayer();
        }

        function showTargetModal() {
            let container = document.getElementById("target-buttons");
            container.innerHTML = "";
            for(let i=1; i<=3; i++) {
                container.innerHTML += `<button class="btn-action" style="background:#2c3e50; font-size:18px;" onclick="selectTarget(${i})">å° ${players[i].name} ç™¼å‹•</button><br>`;
            }
            document.getElementById("target-modal").style.display = "block";
        }

        function cancelTargetSelection() {
            document.getElementById("target-modal").style.display = "none";
            pendingActionIdx = -1;
        }

        async function selectTarget(targetId) {
            document.getElementById("target-modal").style.display = "none";
            let idx = pendingActionIdx; pendingActionIdx = -1;
            if(idx === -1) return;

            let card = players[0].actionHand[idx];
            hasPlayedActionThisTurn = true; 
            isAnimating = true;
            let el = document.getElementById(`my-action-${idx}`);
            if(el) el.classList.add("animate-exit");

            await sleep(300);
            actionDiscardPile.push(players[0].actionHand.splice(idx, 1)[0]);

            if (card.cat === "attack" || card.effectId === "skip" || card.effectId === "bg") {
                await playCinematicAsync(card, `ğŸ‘¤ ${players[0].name}`, `å°ã€${players[targetId].name}ã€‘ç™¼å‹•æ•ˆæœï¼`);
                
                if(card.effectId === "bg") {
                    await executeCardEffect(card, 0, targetId);
                } else {
                    await processAttack(0, targetId, card, async function(finalTargetId) { 
                        await executeCardEffect(card, 0, finalTargetId); 
                    });
                }
            } else {
                await playCinematicAsync(card, `ğŸ‘¤ ${players[0].name}`, `ç™¼å‹•äº†å¡ç‰Œï¼`);
                await executeCardEffect(card, 0, targetId);
            }
            isAnimating = false;
        }

        let selectCardResolve = null;
        function showCardSelectionModal(title, msg, cards) {
            return new Promise(resolve => {
                selectCardResolve = resolve;
                document.getElementById("select-card-title").innerText = title;
                document.getElementById("select-card-msg").innerText = msg;
                
                let container = document.getElementById("select-card-container");
                container.innerHTML = cards.map((c, i) => {
                    let imgHtml = generateImgHtml(c);
                    return `
                    <div class="card type-${c.type}" style="cursor:pointer; width: 100px; min-height: 130px; transform: none; padding: 10px;" onclick="resolveSelectCard(${i})">
                        ${imgHtml}
                        <div class="card-title">${c.name}</div>
                        <div class="card-type-badge">${typeMap[c.type]}</div>
                    </div>
                    `;
                }).join("");
                
                document.getElementById("select-card-modal").style.display = "block";
            });
        }

        function resolveSelectCard(index) {
            document.getElementById("select-card-modal").style.display = "none";
            if(selectCardResolve) selectCardResolve(index);
        }

        let exchangeResolve = null;
        let exHandIdx = -1;
        let exDiscardIdx = -1;

        function showExchangeModal(handCards, targetCards, isCopy=false, targetName="", hideTargetPanel=false) {
            return new Promise(resolve => {
                exchangeResolve = resolve;
                exHandIdx = -1;
                exDiscardIdx = -1;
                window.currentExDiscards = targetCards; 
                
                if (hideTargetPanel) {
                    document.getElementById("exchange-modal-desc").innerText = `è«‹é»æ“Šé¸æ“‡ä½ è¦ä¸Ÿæ£„çš„æ‰‹ç‰Œ`;
                    document.getElementById("exchange-right-panel").style.display = "none";
                    document.getElementById("exchange-left-title").innerText = "é»æ“Šè¦ä¸Ÿæ£„çš„ç‰Œ";
                } else {
                    document.getElementById("exchange-right-panel").style.display = "block";
                    if (isCopy) {
                        document.getElementById("exchange-modal-desc").innerText = `è«‹é¸æ“‡ä½ è¦é€å‡ºçš„ç‰Œï¼Œä»¥åŠä½ è¦å¾ ${targetName} æ‰‹ä¸ŠæŠ½èµ°çš„ç‰Œ`;
                        document.getElementById("exchange-target-title").innerText = `2. ${targetName} çš„æ‰‹ç‰Œ`;
                    } else {
                        document.getElementById("exchange-modal-desc").innerText = `è«‹é¸æ“‡ä½ è¦ä¸Ÿæ£„çš„æ‰‹ç‰Œï¼Œä»¥åŠè¦æ’¿å›çš„æ£„ç‰Œ`;
                        document.getElementById("exchange-target-title").innerText = `2. æ’¿å›å…©å›åˆå…§æ£„ç‰Œ`;
                    }
                }

                renderExchangeModal(isCopy, hideTargetPanel);
                document.getElementById("exchange-card-modal").style.display = "block";
            });
        }

        function renderExchangeModal(isCopy=false, hideTargetPanel=false) {
            let hCont = document.getElementById("exchange-hand-container");
            hCont.innerHTML = players[0].hand.map((c, i) => {
                let cls = `card type-${c.type} ${exHandIdx === i ? 'selected' : ''}`;
                let imgHtml = generateImgHtml(c);
                return `<div class="${cls}" onclick="exHandIdx=${i}; renderExchangeModal(${isCopy}, ${hideTargetPanel})">
                    ${imgHtml}<div class="card-title">${c.name}</div></div>`;
            }).join("");

            if (!hideTargetPanel) {
                let dCont = document.getElementById("exchange-discard-container");
                dCont.innerHTML = window.currentExDiscards.map((c, i) => {
                    let cls = `card type-${c.type} ${exDiscardIdx === i ? 'selected' : ''}`;
                    let content = isCopy ? `<div class="card-title" style="font-size:30px; margin-top:20px;">â“</div>` : `${generateImgHtml(c)}<div class="card-title">${c.name}</div>`;
                    let displayType = isCopy ? "Wildcard" : c.type; 

                    return `<div class="card type-${displayType} ${exDiscardIdx === i ? 'selected' : ''}" onclick="exDiscardIdx=${i}; renderExchangeModal(${isCopy}, false)">${content}</div>`;
                }).join("");
            }
        }

        function confirmExchange() {
            let rightPanelHidden = document.getElementById("exchange-right-panel").style.display === "none";
            if(exHandIdx === -1 || (!rightPanelHidden && exDiscardIdx === -1)) return alert("è«‹æ­£ç¢ºé¸æ“‡å¡ç‰Œï¼");
            document.getElementById("exchange-card-modal").style.display = "none";
            if(exchangeResolve) exchangeResolve({ handIdx: exHandIdx, discardIdx: exDiscardIdx });
        }
        function cancelExchange() {
            document.getElementById("exchange-card-modal").style.display = "none";
            if(exchangeResolve) exchangeResolve(null);
        }

        async function playActionCard(index) {
            if (isAnimating || currentPlayerIndex !== 0) return;
            if (playerImmune.skipOrder) return showToast("âŒ å—è² é¢ç‹€æ…‹å½±éŸ¿ï¼Œä½ æœ¬å›åˆç„¡æ³•æ‰“åŠŸèƒ½ç‰Œï¼");
            if (globalEffects.noAction > 0 && !playerImmune.noAction) return showToast("âŒ é†«é™¢å…¨åŸŸç®¡åˆ¶ä¸­ï¼Œç¦æ­¢æ‰“å‡ºåŠŸèƒ½ç‰Œï¼");
            if (hasPlayedActionThisTurn) return showToast("âš ï¸ ä¸€å›åˆåªèƒ½ä¸»å‹•æ‰“å‡º 1 å¼µåŠŸèƒ½ç‰Œï¼");
            
            let card = players[0].actionHand[index];
            if(card.cat === "defend") return showToast("ğŸ›¡ï¸ é˜²ç¦¦ç‰Œåªèƒ½åœ¨å—åˆ°æ”»æ“Šæ™‚è‡ªå‹•ç™¼å‹•å–”ï¼");
            
            if(card.cat === "attack" || card.effectId === "bg" || card.effectId === "skip") {
                pendingActionIdx = index;
                showTargetModal();
            } else {
                if (card.effectId === "chart") {
                    let recentDiscards = discardPile.filter(c => (completedRounds - c.roundDiscarded) <= 2);
                    if(players[0].hand.length === 0) return showToast("âš ï¸ æ‰‹ä¸Šæ²’æœ‰é†«å­¸ç‰Œå¯ä»¥æ£„ç½®ï¼");
                    if(recentDiscards.length === 0) return showToast("âš ï¸ å…©å›åˆå…§æ²’æœ‰ä»»ä½•æ£„ç‰Œå¯ä»¥æ’¿å›ï¼");
                }
                if (card.effectId === "duty" && players[0].hand.length === 0) {
                    return showToast("âš ï¸ ä½ æ‰‹ä¸Šæ²’æœ‰é†«å­¸ç‰Œå¯ä»¥ä½œç‚ºä»£åƒ¹ä¸Ÿæ£„ï¼");
                }
                
                hasPlayedActionThisTurn = true; 
                isAnimating = true;
                let el = document.getElementById(`my-action-${index}`);
                if(el) el.classList.add("animate-exit");
                await sleep(300);
                actionDiscardPile.push(players[0].actionHand.splice(index, 1)[0]);
                await playCinematicAsync(card, `ğŸ‘¤ ${players[0].name}`, `ç™¼å‹•äº†å¡ç‰Œï¼`);
                await executeCardEffect(card, 0, 0); 
                isAnimating = false;
            }
        }

        async function processAttack(attackerId, targetId, card, effectCallback, depth = 0) {
            if (depth > 4) return; 
            let t = players[targetId];
            
            let reflectIdx = t.actionHand.findIndex(c => c.effectId === "reflect");
            let transferIdx = t.actionHand.findIndex(c => c.effectId === "transfer");
            let pmoffIdx = t.actionHand.findIndex(c => c.effectId === "pmoff");
            let defIdx = reflectIdx !== -1 ? reflectIdx : (transferIdx !== -1 ? transferIdx : pmoffIdx);

            if (t.isHuman) {
                if (defIdx !== -1) {
                    if (confirm(`âš ï¸ ã€${players[attackerId].name}ã€‘å°ä½ ä½¿ç”¨äº†ã€${card.name}ã€‘ï¼\nè¦ç™¼å‹•é˜²ç¦¦ç‰Œã€${t.actionHand[defIdx].name}ã€‘å—ï¼Ÿ`)) {
                        let defCard = t.actionHand.splice(defIdx, 1)[0];
                        actionDiscardPile.push(defCard);
                        await playCinematicAsync(defCard, `ğŸ‘¤ ${t.name}`, `ç™¼å‹•é˜²ç¦¦ï¼`);
                        
                        if (defCard.effectId === "reflect") { 
                            showToast(`ğŸ›¡ï¸ åå½ˆï¼æ”»æ“Šè½‰å‘åŸç™¼å‹•è€…ï¼`); 
                            await effectCallback(attackerId); 
                        } else if (defCard.effectId === "transfer") {
                            let nextTarget = (targetId + 1) % 4;
                            showToast(`ğŸ›¡ï¸ äº¤ç­ï¼æ”»æ“Šè½‰ç§»çµ¦ ${players[nextTarget].name}ï¼`);
                            await processAttack(attackerId, nextTarget, card, effectCallback, depth + 1);
                        } else { 
                            showToast(`ğŸ›¡ï¸ PM OFF æŠµéŠ·ï¼é›™æ–¹å„æŠ½ 1 å¼µç‰Œï¼`);
                            let n1=drawFromDeck('medical'); if(n1) players[attackerId].hand.push(Object.assign({isSelected:false, isNew:true}, n1));
                            let n2=drawFromDeck('medical'); if(n2) t.hand.push(Object.assign({isSelected:false, isNew:true}, n2));
                        }
                        return renderAll();
                    }
                }
                await effectCallback(targetId);
            } else {
                if (defIdx !== -1) {
                    let defCard = t.actionHand.splice(defIdx, 1)[0];
                    actionDiscardPile.push(defCard);
                    await playCinematicAsync(defCard, `ğŸ¤– ${t.name}`, `ç™¼å‹•é˜²ç¦¦ï¼`);
                    
                    if (defCard.effectId === "reflect") { 
                        showToast(`ğŸ›¡ï¸ ${t.name} ç™¼å‹•åå½ˆï¼æ”»æ“Šå½ˆå›å»äº†ï¼`); 
                        await effectCallback(attackerId); 
                    } else if (defCard.effectId === "transfer") {
                        let nextTarget = (targetId + 1) % 4;
                        showToast(`ğŸ›¡ï¸ ${t.name} ç™¼å‹•äº¤ç­ï¼æ”»æ“Šè½‰ç§»çµ¦ ${players[nextTarget].name}ï¼`);
                        await processAttack(attackerId, nextTarget, card, effectCallback, depth + 1);
                    } else { 
                        showToast(`ğŸ›¡ï¸ ${t.name} PM OFF æŠµéŠ·äº†æ”»æ“Šï¼`);
                        let n1=drawFromDeck('medical'); if(n1) players[attackerId].hand.push(Object.assign({isSelected:false, isNew:true}, n1));
                        let n2=drawFromDeck('medical'); if(n2) t.hand.push(Object.assign({isSelected:false, isNew:true}, n2));
                    }
                    return renderAll();
                }
                await effectCallback(targetId);
            }
        }

        async function executeCardEffect(card, uId, tId) {
            let u = players[uId];
            let t = players[tId];

            switch(card.effectId) {
                case "seminar": u.maxLimit++; showToast(`ğŸ§‘â€ğŸ« ${u.name} æ‰‹ç‰Œä¸Šé™ +1ï¼`); break;
                case "dnr": u.hasDNR = true; showToast(`ğŸ›‘ ${u.name} ç°½ç½² DNRï¼`); break;
                case "call": 
                    let d1 = [drawFromDeck('medical'), drawFromDeck('medical'), drawFromDeck('medical')].filter(Boolean);
                    if(d1.length===0) { showToast("ç‰Œåº«ç©ºäº†ï¼"); break; }
                    if(u.isHuman) {
                        let pick1 = await showCardSelectionModal("ğŸ“ Callä¸Šç·š", "è«‹é¸æ“‡ 1 å¼µä¿ç•™åŠ å…¥æ‰‹ç‰Œï¼Œå…¶é¤˜å°‡æ´—å›ç‰Œåº«ï¼š", d1);
                        let kept1 = d1.splice(pick1, 1)[0];
                        kept1.isSelected=false; kept1.isNew=true; u.hand.push(kept1);
                        d1.forEach(c => medicalDeck.push(c));
                        medicalDeck.sort(() => Math.random() - 0.5); 
                        showToast(`ğŸ“ é¸æ“‡äº† 1 å¼µç‰Œï¼Œå…¶é¤˜å·²æ´—å›ï¼`);
                    } else {
                        let pick1 = Math.floor(Math.random() * d1.length);
                        let kept1 = d1.splice(pick1, 1)[0];
                        kept1.isSelected=false; kept1.isNew=true; u.hand.push(kept1);
                        d1.forEach(c => medicalDeck.push(c));
                        medicalDeck.sort(() => Math.random() - 0.5);
                        showToast(`ğŸ¤– ${u.name} æª¢è¦–äº†ç‰Œå †é ‚ç«¯ä¸¦æ‹¿èµ° 1 å¼µï¼`);
                    }
                    break;
                case "combine":
                    let d2 = [drawFromDeck('medical'), drawFromDeck('medical')].filter(Boolean);
                    if(d2.length===0) { showToast("ç‰Œåº«ç©ºäº†ï¼"); break; }
                    if(u.isHuman) {
                        let pick2 = await showCardSelectionModal("ğŸ”¬ Combine", "è«‹é¸æ“‡ 1 å¼µä¿ç•™åŠ å…¥æ‰‹ç‰Œï¼Œå¦ 1 å¼µå°‡ç›´æ¥æ£„ç½®ï¼š", d2);
                        let kept2 = d2.splice(pick2, 1)[0];
                        kept2.isSelected=false; kept2.isNew=true; u.hand.push(kept2);
                        d2.forEach(c => addToDiscard(c, u.name)); 
                        showToast(`ğŸ”¬ é¸æ“‡äº† 1 å¼µç‰Œï¼Œå¦ä¸€å¼µå·²ä¸Ÿæ£„ï¼`);
                    } else {
                        let pick2 = Math.floor(Math.random() * d2.length);
                        let kept2 = d2.splice(pick2, 1)[0];
                        kept2.isSelected=false; kept2.isNew=true; u.hand.push(kept2);
                        d2.forEach(c => addToDiscard(c, u.name));
                        showToast(`ğŸ¤– ${u.name} æª¢è¦–äº†ç‰Œå †é ‚ç«¯ä¸¦æ£„ç½®äº† 1 å¼µç‰Œï¼`);
                    }
                    break;
                case "chart":
                    let recentDiscards = discardPile.filter(c => (completedRounds - c.roundDiscarded) <= 2);
                    if(u.hand.length === 0 || recentDiscards.length === 0) break; 
                    
                    if(u.isHuman) {
                        let ex = await showExchangeModal(u.hand, recentDiscards, false);
                        if (!ex) {
                            showToast("å–æ¶ˆç™¼å‹•è£œç—…æ­·ã€‚");
                            let returnedCard = actionDiscardPile.pop();
                            returnedCard.isNew = true; 
                            u.actionHand.push(returnedCard); 
                            hasPlayedActionThisTurn = false;
                            break; 
                        }
                        let dropCard = u.hand.splice(ex.handIdx, 1)[0];
                        let targetCard = recentDiscards[ex.discardIdx];
                        let actualIdx = discardPile.indexOf(targetCard);
                        let pickupCard = discardPile.splice(actualIdx, 1)[0];
                        
                        addToDiscard(dropCard, u.name);
                        pickupCard.isSelected=false; pickupCard.isNew=true;
                        u.hand.push(pickupCard);
                        showToast(`ğŸ“ è£œç—…æ­·æˆåŠŸï¼ç”¨ã€${dropCard.name}ã€‘æ›å›äº†ã€${pickupCard.name}ã€‘`);
                    } else {
                        let hIdx = Math.floor(Math.random() * u.hand.length);
                        let dIdx = Math.floor(Math.random() * recentDiscards.length);
                        let dropCard = u.hand.splice(hIdx, 1)[0];
                        let targetCard = recentDiscards[dIdx];
                        let actualIdx = discardPile.indexOf(targetCard);
                        let pickupCard = discardPile.splice(actualIdx, 1)[0];
                        
                        addToDiscard(dropCard, u.name);
                        pickupCard.isSelected=false; pickupCard.isNew=true;
                        u.hand.push(pickupCard);
                        showToast(`ğŸ¤– ${u.name} ç™¼å‹•è£œç—…æ­·ï¼Œå¾æ£„ç‰Œå€æ’¿èµ°äº†ä¸€å¼µç‰Œï¼`);
                    }
                    break;

                case "report": 
                    t.isRevealed = true; 
                    showToast(`ğŸ“¢ é–å®šç›®æ¨™ï¼ã€${t.name}ã€‘çš„æ‰‹ç‰Œå·²è¢«å…¬é–‹ï¼Œç›´åˆ°æœ¬å›åˆçµæŸï¼`); 
                    break;
                    
                case "tryhard":
                    if (t.hand.length > 0) {
                        let ccIdx = t.hand.findIndex(c => c.type === "CC");
                        let dropIdx = ccIdx !== -1 ? ccIdx : Math.floor(Math.random() * t.hand.length);
                        addToDiscard(t.hand.splice(dropIdx, 1)[0], t.name);
                        showToast(`ğŸ‘º ${t.name} è¢«è¿«æ£„ç‰Œï¼`);
                        let n3=drawFromDeck('medical'); if(n3) t.hand.push(Object.assign({isSelected:false, isNew:true}, n3));
                    } else showToast(`${t.name} æ²’ç‰Œå¯ä¸Ÿï¼`); break;
                case "audit":
                    if (t.table.length > 0) {
                        let tCase = t.table.splice(0, 1)[0]; 
                        let txIndex = tCase.findIndex(c => c.type === "Tx" || c.type === "Wildcard"); 
                        if(txIndex !== -1) addToDiscard(tCase.splice(txIndex, 1)[0], t.name); 
                        tCase.forEach(c => { c.isSelected=false; t.hand.push(c); });
                        showToast(`âœ‚ï¸ ${t.name} çš„ç—…åºŠè¢«æ‘§æ¯€ï¼Œä¸”è¢«æ‹”é™¤äº†æ²»ç™‚ç‰Œï¼`);
                    } else showToast(`${t.name} æ²’æœ‰ç—…äººå¯æ ¸åˆªï¼`); break;
                
                case "copy":
                    if (u.hand.length > 0 && t.hand.length > 0) {
                        if (u.isHuman) {
                            let ex = await showExchangeModal(u.hand, t.hand, true, t.name);
                            if (!ex) {
                                showToast("å–æ¶ˆç™¼å‹•æŠ„æ¨¡æ¿ã€‚");
                                let returnedCard = actionDiscardPile.pop(); returnedCard.isNew = true; 
                                u.actionHand.push(returnedCard); hasPlayedActionThisTurn = false;
                                break;
                            }
                            let uCard = u.hand.splice(ex.handIdx, 1)[0];
                            let tCard = t.hand.splice(ex.discardIdx, 1)[0];
                            uCard.isSelected = false; tCard.isSelected = false; uCard.isNew = true; tCard.isNew = true; 
                            u.hand.push(tCard); t.hand.push(uCard);
                            showToast(`ğŸ“ ä½ ç”¨ã€${uCard.name}ã€‘æ›ä¾†äº†ã€${tCard.name}ã€‘ï¼`);
                        } else {
                            let uCard = u.hand.splice(Math.floor(Math.random()*u.hand.length), 1)[0];
                            let tCard = t.hand.splice(Math.floor(Math.random()*t.hand.length), 1)[0];
                            uCard.isSelected = false; tCard.isSelected = false; uCard.isNew = true; tCard.isNew = true; 
                            u.hand.push(tCard); t.hand.push(uCard);
                            showToast(`ğŸ“ ğŸ¤– ${u.name} èˆ‡ ${t.name} äº’æ›äº† 1 å¼µæ‰‹ç‰Œï¼`);
                        }
                    } else showToast("é›™æ–¹æ‰‹ç‰Œä¸è¶³ç„¡æ³•äº¤æ›ï¼"); break;
                
                case "chaos":
                    let uHandCount = u.hand.length;
                    players.forEach(p => {
                        let dropCount = Math.min(uHandCount, p.hand.length);
                        for(let i=0; i<dropCount; i++) {
                            addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                        }
                        for(let i=0; i<dropCount; i++) {
                            let c1 = drawFromDeck('medical'); if(c1) { c1.isSelected=false; c1.isNew=true; p.hand.push(c1); }
                        }
                    });
                    showToast(`ğŸŒªï¸ å¤§æ··äº‚ç”Ÿæ•ˆï¼æ‰€æœ‰äººè¢«è¿«æ›´æ›äº† ${uHandCount} å¼µç‰Œï¼`); break;

                case "shift":
                    players.forEach(p => {
                        let count = p.actionHand.length;
                        while(p.actionHand.length > 0) actionDiscardPile.push(p.actionHand.pop());
                        for(let i=0; i<count; i++) { let a=drawFromDeck('action'); if(a) p.actionHand.push(a); }
                    });
                    
                    if (u.actionHand.length < 3) {
                        let extraAct = drawFromDeck('action');
                        if (extraAct) { extraAct.isNew = true; u.actionHand.push(extraAct); }
                        showToast(`ğŸ”„ æ›ç§‘ç”Ÿæ•ˆï¼æ‰€æœ‰äººé‡æ–°æŠ½å–åŠŸèƒ½ç‰Œï¼Œä¸” ${u.name} é¡å¤–ç²å¾— 1 å¼µåŠŸèƒ½ç‰Œï¼`);
                    } else {
                        showToast(`ğŸ”„ æ›ç§‘ç”Ÿæ•ˆï¼æ‰€æœ‰äººé‡æ–°æŠ½å–åŠŸèƒ½ç‰Œï¼`);
                    }
                    break;
                
                case "choose":
                    players.forEach(p => {
                        let m = drawFromDeck('medical'); if(m) p.hand.push(Object.assign({isSelected:false, isNew:true}, m));
                        if(p.hand.length > 0) addToDiscard(p.hand.splice(Math.floor(Math.random()*p.hand.length), 1)[0], p.name);
                    });
                    showToast(`ğŸ“ é¸ç§‘ç”Ÿæ•ˆï¼æ‰€æœ‰äººå„æŠ½ 1 å¼µä¸¦æ£„ 1 å¼µï¼`); break;

                case "bg":
                    let tActionCount = t.actionHand.length;
                    while (u.actionHand.length < tActionCount && u.actionHand.length < 3) {
                        let act = drawFromDeck('action');
                        if(act) { act.isNew = true; u.actionHand.push(act); }
                    }
                    showToast(`ğŸ˜ é è‘— BGï¼${u.name} æŠŠåŠŸèƒ½ç‰ŒæŠ½åˆ°äº† ${u.actionHand.length} å¼µï¼`);
                    break;

                case "skip":
                    t.skipTurn = true;
                    showToast(`ğŸš« ${t.name} è¢«æŒ‡æ´¾äº†æ ¸å¿ƒèª²ç¨‹ï¼Œä¸‹ä¸€å›åˆè¢«è·³éï¼`);
                    break;

                case "flag":
                    showToast(`ğŸš¨ ç«‹ Flag æˆåŠŸï¼ä»Šå¤©æ²’äº‹... é†«é™¢çˆ†ç™¼ç·Šæ€¥äº‹ä»¶äº†ï¼`);
                    // ä¸é‡ç½® nextEventRoundï¼Œç›´æ¥å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡äº‹ä»¶
                    await triggerRandomEvent();
                    break;

                case "duty":
                    if(u.hand.length === 0) break;
                    
                    if (u.isHuman) {
                        let ex = await showExchangeModal(u.hand, [], false, "", true); 
                        if (!ex && exHandIdx === -1) {
                            showToast("å–æ¶ˆç™¼å‹•æˆ‘æ„›åŠ ç­ã€‚");
                            let returnedCard = actionDiscardPile.pop(); returnedCard.isNew = true; 
                            u.actionHand.push(returnedCard); hasPlayedActionThisTurn = false;
                            break;
                        }
                        
                        let dummyOpts = [
                            { type: "CC", name: "æŠ½ä¸»è¨´ç‰Œ", img: "" }, { type: "Sx", name: "æŠ½ç—‡ç‹€ç‰Œ", img: "" },
                            { type: "Dx", name: "æŠ½è¨ºæ–·ç‰Œ", img: "" }, { type: "Tx", name: "æŠ½æ²»ç™‚ç‰Œ", img: "" }
                        ];
                        let typePickIdx = await showCardSelectionModal("ğŸ¥ å€¼ç­æª¢ç´¢", "è«‹é¸æ“‡ä½ æƒ³è¦å¾ç‰Œå †ä¸­æŠ½å–çš„ç‰Œç¨®é¡ï¼š", dummyOpts);
                        let targetType = dummyOpts[typePickIdx].type;

                        let dropCard = u.hand.splice(exHandIdx, 1)[0];
                        addToDiscard(dropCard, u.name);

                        let foundIdx = medicalDeck.findIndex(c => c.type === targetType);
                        if (foundIdx !== -1) {
                            let drawn = medicalDeck.splice(foundIdx, 1)[0];
                            drawn.isSelected = false; drawn.isNew = true;
                            u.hand.push(drawn);
                            medicalDeck.sort(() => Math.random() - 0.5); 
                            showToast(`ğŸ¥ æˆ‘æ„›åŠ ç­ï¼ä¸Ÿæ£„äº†ã€${dropCard.name}ã€‘ï¼Œä¸¦æŠ½å‡ºäº†ã€${drawn.name}ã€‘ï¼`);
                        } else {
                            showToast(`âš ï¸ ç‰Œå †è£¡å·²ç¶“æ²’æœ‰ ${targetType} é¡å‹çš„ç‰Œäº†ï¼`);
                        }
                    } else {
                        let dropCard = u.hand.splice(Math.floor(Math.random() * u.hand.length), 1)[0];
                        addToDiscard(dropCard, u.name);

                        let needs = ["CC", "Sx", "Dx", "Tx"];
                        let targetType = needs[Math.floor(Math.random() * needs.length)];
                        let foundIdx = medicalDeck.findIndex(c => c.type === targetType);
                        if (foundIdx !== -1) {
                            let drawn = medicalDeck.splice(foundIdx, 1)[0];
                            drawn.isSelected = false; drawn.isNew = true;
                            u.hand.push(drawn);
                            medicalDeck.sort(() => Math.random() - 0.5);
                            showToast(`ğŸ¤– ${u.name} åŠ ç­çµæŸï¼Œå¾ç‰Œå †æª¢ç´¢äº†ä¸€å¼µå¡ç‰Œï¼`);
                        }
                    }
                    break;
            }
            renderAll();
        }

        function renderAll() {
            let p = players[0];
            
            let hc = document.getElementById("hand-cards"); hc.innerHTML = "";
            p.hand.forEach((c, i) => {
                let cls = `card type-${c.type} ${c.isSelected ? "selected" : ""}`;
                if (c.isNew) { cls += " animate-enter"; c.isNew = false; }
                let imgHtml = generateImgHtml(c);
                hc.innerHTML += `<div id="my-card-${i}" class="${cls}" draggable="true" ondragstart="dragStart(event, ${i})" ondragover="dragOver(event)" ondrop="drop(event, ${i})" onclick="toggleCardSelection(${i})">
                    ${imgHtml}<div class="card-title">${c.name}</div><div class="card-type-badge">${typeMap[c.type]}</div></div>`;
            });
            
            let drawBtn = document.getElementById("draw-btn");
            if (hasDrawnThisTurn) { 
                drawBtn.classList.add("disabled"); 
                drawBtn.innerHTML = `ğŸ“¦ å·²æŠ½ç‰Œ <span style="font-size:11px;">(${medicalDeck.length}å¼µ)</span>`; 
            } else { 
                drawBtn.classList.remove("disabled"); 
                drawBtn.innerHTML = `ğŸ“¦ 1. æŠ½ç‰Œ <span style="font-size:11px;">(${medicalDeck.length}å¼µ)</span>`; 
            }

            let pLimit = (globalEffects.handLimit > 0 && !playerImmune.handLimit) ? 5 : p.maxLimit;
            let btnClass = (currentPlayerIndex !== 0 || p.hand.length > pLimit || playerImmune.skipOrder) ? 'btn-action disabled' : 'btn-action';
            document.getElementById("end-btn").className = btnClass;
            document.getElementById("medical-count-display").innerHTML = `<span style="color:${p.hand.length>pLimit?'red':'#333'}">(${p.hand.length}/${pLimit})</span>`;
            document.getElementById("dnr-status").innerText = p.hasDNR ? "(DNRç”Ÿæ•ˆ)" : "";
            document.getElementById("act-deck-count").innerText = actionDeck.length;

            let ac = document.getElementById("action-hand-cards"); ac.innerHTML = "";
            p.actionHand.forEach((c, i) => {
                let cls = c.isNew ? "card type-Action animate-enter" : "card type-Action"; c.isNew = false;
                let imgHtml = generateImgHtml(c);
                ac.innerHTML += `<div id="my-action-${i}" class="${cls}" onclick="playActionCard(${i})">
                    ${imgHtml}<div class="card-title">${c.name}</div><div class="action-desc">${c.desc}</div></div>`;
            });
            document.getElementById("action-count-display").innerText = `(${p.actionHand.length}/3)`;

            let dc = document.getElementById("discard-pile");
            if(discardPile.length > 0) {
                let top = discardPile[discardPile.length-1];
                let imgHtml = generateImgHtml(top);
                dc.innerHTML = `<div style="font-size:11px; margin-bottom:2px;">ğŸ‘‡ æœ€æ–°æ£„ç‰Œ</div><div class="card type-${top.type}" style="margin:0; width:65px; padding:4px; pointer-events:none; min-height:70px;">${imgHtml}<div class="card-title" style="font-size:11px;">${top.name}</div></div><div style="font-size:9px; margin-top:2px; color:#3498db; font-weight:bold;">(ç”± ${top.discarder} ä¸Ÿæ£„)</div>`;
            } else { dc.innerHTML = `ğŸ—‘ï¸ é†«å­¸æ£„ç‰Œå€`; }

            document.getElementById("table-cards").innerHTML = p.table.map((c, i) => `<div style="margin-bottom:2px;">ğŸ›ï¸ åºŠä½ ${i+1} [${c.recipeName}]: ` + c.map(card => `<span class="bot-case-card type-${card.type}">${typeMap[card.type]} ${card.name}</span>`).join(" + ") + `</div>`).join("") || "ç›®å‰ç„¡ç—…äºº";

            let oppsContainer = document.getElementById("opponents-container");
            oppsContainer.innerHTML = "";
            for (let i = 1; i <= 3; i++) {
                let bot = players[i];
                let isTurn = currentPlayerIndex === i ? "active-turn" : "";
                let status = bot.hasDNR ? "(DNRç”Ÿæ•ˆ)" : (bot.skipTurn ? "(è¢«è·³é)" : "");
                
                let botHandHtml = bot.isRevealed ? 
                    `<div class="revealed-box" onclick="showRevealedHand(${bot.id})" title="é»æ“Šæ”¾å¤§æŸ¥çœ‹éš±è—æ‰‹ç‰Œ">` +
                    bot.hand.map(c => `<div class="bot-card-back" style="background-color:#e67e22; border-color:#d35400;">ğŸ‘ï¸</div>`).join("") +
                    `</div>` : 
                    bot.hand.map(c => { let cls = c.isNew ? "animate-enter" : ""; c.isNew=false; return `<div class="bot-card-back ${cls}">ğŸ¥</div>`;}).join("");
                
                let botTableHtml = bot.table.map((c, idx) => `<div style="margin-top:2px;">ğŸ›ï¸ ${idx+1} [${c.recipeName}]</div>`).join("") || "ç„¡ç—…äºº";
                let botLimitHtml = (globalEffects.handLimit > 0 && !bot.immuneHandLimit) ? `(ä¸Šé™ 5)` : "";

                oppsContainer.innerHTML += `
                    <div class="bot-area ${isTurn}">
                        <h3 style="margin:2px 0; font-size: 13px;">ğŸ¤– ${bot.name} <span style="font-size:10px;color:red;">${status}</span></h3>
                        <div style="font-size:11px; background:#fff; padding:3px; border-radius:5px; margin-bottom:3px; min-height:20px;">
                            <strong>ç—…åºŠå€ï¼š</strong><br>${botTableHtml}
                        </div>
                        <div style="font-size:10px;">é†«å­¸ç‰Œ: ${bot.hand.length} <span style="color:red">${botLimitHtml}</span> | åŠŸèƒ½ç‰Œ: ${bot.actionHand.length}</div>
                        <div style="margin-top:2px;">${botHandHtml}</div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>